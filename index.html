<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Meta tags for PWA (Add to Home Screen) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ef4444"> <!-- Matches header red -->
    <title>Emi AI Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Markdown Parser for AI responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* –ë–∞–∑–æ–≤—ñ —Å—Ç–∏–ª—ñ */
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(0, 0, 0, 0.1); border-radius: 20px; }
        
        @keyframes popIn {
            0% { opacity: 0; transform: translateY(10px) scale(0.95); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        .message-bubble {
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .chat-bg {
            background-color: #e5ddd5;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239c92ac' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .tab-content { transition: opacity 0.2s ease-in-out; }
        .tab-content.hidden { display: none; opacity: 0; }
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }

        /* --- DARK MODE STYLES --- */
        body.dark-mode { background-color: #111827; }
        body.dark-mode .bg-white { background-color: #1f2937; color: #f3f4f6; border-color: #374151; }
        body.dark-mode .bg-gray-50 { background-color: #111827; }
        body.dark-mode .bg-gray-100 { background-color: #374151; }
        body.dark-mode .bg-yellow-50 { background-color: #422006; border-color: #713f12; }
        body.dark-mode .bg-blue-50 { background-color: #1e3a8a; border-color: #1e40af; }
        body.dark-mode .bg-red-50 { background-color: #450a0a; color: #fecaca; }
        body.dark-mode .text-gray-800 { color: #f9fafb; }
        body.dark-mode .text-gray-700 { color: #e5e7eb; }
        body.dark-mode .text-gray-600 { color: #d1d5db; }
        body.dark-mode .text-gray-500 { color: #9ca3af; }
        body.dark-mode .text-gray-400 { color: #9ca3af; }
        body.dark-mode .border-gray-100 { border-color: #374151; }
        body.dark-mode .border-gray-200 { border-color: #4b5563; }
        body.dark-mode .border-red-100 { border-color: #7f1d1d; }
        body.dark-mode .chat-bg { background-color: #0f172a; filter: invert(0.05); }
        body.dark-mode input, body.dark-mode textarea { 
            background-color: #374151; 
            color: white; 
            border-color: #4b5563; 
        }
        body.dark-mode .hover\:bg-gray-100:hover { background-color: #374151; }
        body.dark-mode #sidebar { background-color: #1f2937; border-right: 1px solid #374151; }
    </style>
</head>
<body class="bg-gray-50 h-screen w-screen overflow-hidden font-sans">

    <!-- App Container (Full Screen) -->
    <div class="relative w-full h-full flex flex-col bg-white transition-colors duration-300">
        
        <!-- === SIDEBAR DRAWER === -->
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="absolute inset-0 bg-black/50 z-40 hidden opacity-0"></div>

        <aside id="sidebar" class="absolute top-0 left-0 bottom-0 w-[300px] bg-white z-50 transform -translate-x-full shadow-2xl flex flex-col transition-colors duration-300 h-full">
            <!-- Sidebar Header -->
            <div class="h-[160px] bg-red-500 p-5 flex flex-col justify-end text-white relative overflow-hidden shrink-0">
                <div class="absolute -top-10 -right-10 w-32 h-32 bg-white/10 rounded-full"></div>
                <div class="absolute top-10 right-10 w-10 h-10 bg-white/10 rounded-full"></div>
                <div class="w-16 h-16 bg-white rounded-full mb-3 flex items-center justify-center text-3xl shadow-sm border-2 border-white/30 cursor-pointer hover:scale-105 transition overflow-hidden text-gray-800" onclick="switchTab('profile')">üë§</div>
                <div id="sidebar-username" class="font-bold text-lg leading-none">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</div>
                <div class="text-sm text-red-100 mt-1 opacity-80" data-i18n="playerTitle">–ì—Ä–∞–≤–µ—Ü—å</div>
            </div>
            
            <!-- Sidebar Menu Items -->
            <nav class="flex-1 overflow-y-auto py-2">
                <button onclick="switchTab('profile')" class="w-full flex items-center gap-4 px-5 py-3 text-gray-700 hover:bg-gray-100 active:bg-gray-200 transition">
                    <i data-lucide="user" class="w-5 h-5 text-gray-500"></i>
                    <span class="font-medium" data-i18n="myProfile">–ú—ñ–π –ü—Ä–æ—Ñ—ñ–ª—å</span>
                </button>
                <div class="border-b border-gray-100 my-1"></div>
                <button onclick="switchTab('chat')" class="w-full flex items-center gap-4 px-5 py-3 text-gray-700 hover:bg-gray-100 active:bg-gray-200 transition">
                    <i data-lucide="message-circle" class="w-5 h-5 text-gray-500"></i>
                    <div class="flex-1 text-left font-medium" data-i18n="chatWithEmi">–ß–∞—Ç –∑ Emi</div>
                    <span class="bg-red-500 text-white text-[10px] font-bold px-1.5 rounded-full">1</span>
                </button>
                <button onclick="switchTab('notes')" class="w-full flex items-center gap-4 px-5 py-3 text-gray-700 hover:bg-gray-100 active:bg-gray-200 transition">
                    <i data-lucide="sticky-note" class="w-5 h-5 text-gray-500"></i>
                    <span class="font-medium" data-i18n="notes">–ù–æ—Ç–∞—Ç–∫–∏</span>
                </button>
                <button onclick="switchTab('calendar')" class="w-full flex items-center gap-4 px-5 py-3 text-gray-700 hover:bg-gray-100 active:bg-gray-200 transition">
                    <i data-lucide="calendar" class="w-5 h-5 text-gray-500"></i>
                    <span class="font-medium" data-i18n="calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä</span>
                </button>
                <button onclick="switchTab('games')" class="w-full flex items-center gap-4 px-5 py-3 text-gray-700 hover:bg-gray-100 active:bg-gray-200 transition">
                    <i data-lucide="gamepad-2" class="w-5 h-5 text-gray-500"></i>
                    <span class="font-medium" data-i18n="games">–Ü–≥—Ä–∏</span>
                </button>
                <div class="border-b border-gray-100 my-1"></div>
                <button onclick="switchTab('profile')" class="w-full flex items-center gap-4 px-5 py-3 text-gray-700 hover:bg-gray-100 active:bg-gray-200 transition">
                    <i data-lucide="settings" class="w-5 h-5 text-gray-500"></i>
                    <span class="font-medium" data-i18n="settings">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</span>
                </button>
            </nav>
        </aside>

        <!-- === MAIN CONTENT AREA === -->
        <div class="flex-1 overflow-hidden relative bg-white transition-colors duration-300 w-full h-full flex flex-col">

            <!-- TAB 1: CHAT -->
            <div id="view-chat" class="tab-content h-full flex flex-col w-full">
                <!-- Header -->
                <header class="bg-red-500 text-white p-4 pt-safe flex items-center justify-between shadow-md z-10 shrink-0 h-[60px] md:h-[70px]">
                    <div class="flex items-center gap-4">
                        <button onclick="toggleSidebar()" class="p-1 hover:bg-red-400 rounded-full transition active:scale-95">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>
                        <div class="flex items-center gap-3">
                            <div class="relative">
                                <div class="w-10 h-10 rounded-full bg-red-100 border-2 border-red-200 overflow-hidden flex items-center justify-center">
                                    <img src="https://cdn-icons-png.flaticon.com/512/415/415733.png" alt="Emi Avatar" class="w-8 h-8 object-contain">
                                </div>
                                <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-400 border-2 border-red-500 rounded-full"></div>
                            </div>
                            <div class="flex flex-col">
                                <h1 class="font-bold text-lg leading-none">Emi</h1>
                                <p class="text-xs text-red-100 mt-0.5">Online</p>
                            </div>
                        </div>
                    </div>
                    <button onclick="startVideoCall()" class="p-2 bg-red-400 hover:bg-red-300 rounded-full transition shadow-sm active:scale-95 group">
                        <i data-lucide="video" class="w-5 h-5 group-hover:text-white"></i>
                    </button>
                </header>

                <main id="chat-content" class="flex-1 chat-bg overflow-y-auto custom-scrollbar p-4 flex flex-col gap-3 w-full max-w-5xl mx-auto">
                    <div class="flex justify-center my-2 opacity-60">
                        <span class="bg-gray-200 text-gray-600 text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-wide shadow-sm" data-i18n="today">–°—å–æ–≥–æ–¥–Ω—ñ</span>
                    </div>
                    <!-- Intro Message -->
                    <div class="message-bubble self-start max-w-[85%] md:max-w-[60%] flex gap-2">
                        <div class="bg-white text-gray-800 rounded-2xl rounded-tl-none py-3 px-4 shadow-sm border border-gray-100">
                            <p class="text-sm md:text-base leading-relaxed" data-i18n="welcomeMessage">–ü—Ä–∏–≤—ñ—Ç! –Ø Emi üçé. –°–ø–æ—á–∞—Ç–∫—É –Ω–∞–ª–∞—à—Ç—É–π —Å–≤—ñ–π API –∫–ª—é—á —É –ø—Ä–æ—Ñ—ñ–ª—ñ, —â–æ–± —è –º–æ–≥–ª–∞ –≥–æ–≤–æ—Ä–∏—Ç–∏!</p>
                            <span class="text-[10px] text-gray-400 block text-right mt-1">10:00</span>
                        </div>
                    </div>
                </main>

                <!-- Input Area -->
                <div class="bg-white p-3 border-t border-gray-100 shrink-0 flex items-center gap-2 z-10 w-full justify-center">
                    <div class="w-full max-w-5xl flex items-center gap-2">
                        <button class="p-2 text-gray-400 hover:text-red-500 transition">
                            <i data-lucide="plus" class="w-6 h-6"></i>
                        </button>
                        <div class="flex-1 bg-gray-100 rounded-full px-4 py-3 flex items-center">
                            <input type="text" id="message-input" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." 
                                class="w-full bg-transparent outline-none text-base text-gray-800 placeholder-gray-400"
                                autocomplete="off" onkeypress="handleKeyPress(event)" data-i18n-placeholder="writeMessage">
                        </div>
                        <button onclick="sendMessage()" class="p-3 bg-red-500 hover:bg-red-600 text-white rounded-full shadow-md transition active:scale-95 flex items-center justify-center">
                            <i data-lucide="send" class="w-5 h-5 ml-0.5"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- TAB 2: NOTES -->
            <div id="view-notes" class="tab-content h-full flex flex-col hidden bg-gray-50 w-full">
                <header class="bg-white p-4 pt-safe border-b border-gray-200 shadow-sm h-[60px] md:h-[70px] flex items-center justify-between shrink-0">
                    <div class="flex items-center gap-4">
                        <button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 rounded-full transition text-gray-600">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>
                        <h1 class="font-bold text-2xl text-gray-800" data-i18n="notes">–ù–æ—Ç–∞—Ç–∫–∏</h1>
                    </div>
                    <button onclick="openNoteForm()" class="p-2 bg-yellow-400 rounded-full text-white shadow-sm hover:bg-yellow-500 transition">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </button>
                </header>
                
                <div id="note-form" class="hidden p-4 bg-yellow-50 border-b border-yellow-100 animate-fade-in shrink-0 w-full max-w-3xl mx-auto mt-4 rounded-xl shadow-sm">
                    <input type="hidden" id="note-index" value="-1">
                    <input type="text" id="note-title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" class="w-full mb-2 p-3 rounded border border-yellow-200 text-base outline-none focus:border-yellow-400 text-gray-800" data-i18n-placeholder="title">
                    <textarea id="note-body" placeholder="–¢–µ–∫—Å—Ç –Ω–æ—Ç–∞—Ç–∫–∏..." class="w-full mb-2 p-3 rounded border border-yellow-200 text-base outline-none focus:border-yellow-400 text-gray-800 resize-none h-32" data-i18n-placeholder="noteText"></textarea>
                    <div class="flex gap-2">
                        <button id="note-submit-btn" onclick="saveNote()" class="flex-1 bg-yellow-400 text-white py-2 rounded text-sm font-bold hover:bg-yellow-500" data-i18n="add">–î–æ–¥–∞—Ç–∏</button>
                        <button onclick="closeNoteForm()" class="px-4 bg-gray-200 text-gray-600 rounded text-sm hover:bg-gray-300" data-i18n="cancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    </div>
                </div>

                <div id="notes-list" class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 overflow-y-auto custom-scrollbar w-full max-w-6xl mx-auto"></div>
            </div>

            <!-- TAB 3: CALENDAR -->
            <div id="view-calendar" class="tab-content h-full flex flex-col hidden bg-white w-full">
                <header class="bg-white p-4 pt-safe border-b border-gray-200 shadow-sm h-[60px] md:h-[70px] flex items-center justify-between shrink-0">
                    <div class="flex items-center gap-4">
                        <button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 rounded-full transition text-gray-600">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>
                        <h1 class="font-bold text-2xl text-gray-800" data-i18n="calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä</h1>
                    </div>
                    <span id="calendar-month-year" class="text-sm font-semibold text-red-500 bg-red-50 px-3 py-1 rounded-full"></span>
                </header>
                <div class="p-4 flex-1 overflow-y-auto w-full max-w-4xl mx-auto">
                    <div class="grid grid-cols-7 mb-2 text-center">
                        <span class="text-xs font-bold text-gray-400" data-i18n="mon">–ü–Ω</span>
                        <span class="text-xs font-bold text-gray-400" data-i18n="tue">–í—Ç</span>
                        <span class="text-xs font-bold text-gray-400" data-i18n="wed">–°—Ä</span>
                        <span class="text-xs font-bold text-gray-400" data-i18n="thu">–ß—Ç</span>
                        <span class="text-xs font-bold text-gray-400" data-i18n="fri">–ü—Ç</span>
                        <span class="text-xs font-bold text-gray-400 text-red-400" data-i18n="sat">–°–±</span>
                        <span class="text-xs font-bold text-gray-400 text-red-400" data-i18n="sun">–ù–¥</span>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center text-sm md:text-base"></div>
                    
                    <div class="mt-8">
                        <h3 class="font-bold text-gray-800 mb-4 flex justify-between items-center text-lg">
                            <span data-i18n="events">–ü–æ–¥—ñ—ó</span>
                            <button onclick="addEventPrompt()" class="text-sm text-red-500 font-medium px-3 py-1 bg-red-50 rounded-lg hover:bg-red-100" data-i18n="addEvent">+ –î–æ–¥–∞—Ç–∏ –ø–æ–¥—ñ—é</button>
                        </h3>
                        <div id="events-list" class="space-y-3 pb-10 grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    </div>
                </div>
            </div>

            <!-- TAB 4: GAMES -->
            <div id="view-games" class="tab-content h-full flex flex-col hidden bg-gray-50 w-full">
                <header class="bg-white p-4 pt-safe border-b border-gray-200 shadow-sm h-[60px] md:h-[70px] flex items-center justify-between shrink-0">
                    <div class="flex items-center gap-4">
                        <button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 rounded-full transition text-gray-600">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>
                        <h1 class="font-bold text-2xl text-gray-800" data-i18n="miniGames">–ú—ñ–Ω—ñ-—ñ–≥—Ä–∏</h1>
                    </div>
                    <div class="bg-gray-100 px-3 py-1 rounded-full flex items-center gap-1">
                        <i data-lucide="coins" class="w-4 h-4 text-yellow-500"></i>
                        <span class="text-xs font-bold text-gray-600">1250</span>
                    </div>
                </header>
                <div class="p-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 overflow-y-auto custom-scrollbar w-full max-w-6xl mx-auto">
                    <!-- Game Cards -->
                    <div class="bg-gradient-to-br from-purple-500 to-indigo-600 p-6 rounded-2xl shadow-lg text-white aspect-[4/3] flex flex-col justify-between hover:scale-105 transition cursor-pointer">
                        <i data-lucide="gamepad-2" class="w-10 h-10 opacity-80"></i>
                        <div>
                            <h3 class="font-bold text-lg" data-i18n="snakeGame">–ó–º—ñ–π–∫–∞</h3>
                            <p class="text-xs opacity-70" data-i18n="classicGame">–ö–ª–∞—Å–∏—á–Ω–∞ –≥—Ä–∞</p>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-400 to-red-500 p-6 rounded-2xl shadow-lg text-white aspect-[4/3] flex flex-col justify-between hover:scale-105 transition cursor-pointer">
                        <i data-lucide="apple" class="w-10 h-10 opacity-80"></i>
                        <div>
                            <h3 class="font-bold text-lg">Apple Catcher</h3>
                            <p class="text-xs opacity-70" data-i18n="catchApples">–ó–±–µ—Ä–∏ —è–±–ª—É–∫–∞</p>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-green-400 to-emerald-600 p-6 rounded-2xl shadow-lg text-white aspect-[4/3] flex flex-col justify-between hover:scale-105 transition cursor-pointer">
                        <i data-lucide="brain-circuit" class="w-10 h-10 opacity-80"></i>
                        <div>
                            <h3 class="font-bold text-lg" data-i18n="memoryGame">–ú–µ–º–æ—Ä—ñ</h3>
                            <p class="text-xs opacity-70" data-i18n="trainMemory">–¢—Ä–µ–Ω—É–π –ø–∞–º'—è—Ç—å</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 5: PROFILE & SETTINGS -->
            <div id="view-profile" class="tab-content h-full flex flex-col hidden bg-gray-50 w-full">
                <header class="bg-white p-4 pt-safe border-b border-gray-200 shadow-sm h-[60px] md:h-[70px] flex items-center justify-between shrink-0">
                    <div class="flex items-center gap-4">
                        <button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 rounded-full transition text-gray-600">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>
                        <h1 class="font-bold text-2xl text-gray-800" data-i18n="profile">–ü—Ä–æ—Ñ—ñ–ª—å</h1>
                    </div>
                    <button class="p-2 text-gray-400 hover:text-gray-600">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                    </button>
                </header>
                
                <div class="flex-1 overflow-y-auto custom-scrollbar pb-10 w-full max-w-3xl mx-auto">
                    <div class="bg-white m-4 p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center">
                        <div class="w-24 h-24 bg-gray-200 rounded-full mb-4 flex items-center justify-center text-4xl text-gray-800">üë§</div>
                        <input id="profile-name-input" type="text" class="text-center font-bold text-2xl text-gray-800 border-b-2 border-transparent focus:border-red-500 outline-none bg-transparent w-full" placeholder="–í–∞—à–µ —ñ–º'—è" data-i18n-placeholder="yourName">
                        <p class="text-sm text-gray-400 mt-2" data-i18n="clickToChange">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å —â–æ–± –∑–º—ñ–Ω–∏—Ç–∏</p>
                    </div>

                    <div class="px-4 mb-4">
                        <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-2 ml-1" data-i18n="whatEmiKnows">–©–æ Emi –∑–Ω–∞—î –ø—Ä–æ —Ç–µ–±–µ</h3>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 space-y-6">
                            <div>
                                <label class="block text-sm text-gray-500 mb-2 font-medium" data-i18n="birthday">–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è</label>
                                <input id="profile-birthday" type="date" class="w-full bg-gray-50 p-3 rounded-xl text-base outline-none focus:ring-2 focus:ring-red-200 text-gray-800 border border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-500 mb-2 font-medium" data-i18n="hobbies">–¢–≤–æ—ó —Ö–æ–±—ñ (–¥–ª—è —Ä–æ–∑–º–æ–≤)</label>
                                <textarea id="profile-hobbies" class="w-full bg-gray-50 p-3 rounded-xl text-base outline-none focus:ring-2 focus:ring-red-200 resize-none h-24 text-gray-800 border border-transparent" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: —Ñ—É—Ç–±–æ–ª, –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è, –º–∞–ª—é–≤–∞–Ω–Ω—è..." data-i18n-placeholder="hobbiesPlaceholder"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- SECURITY & API SETTINGS -->
                    <div class="px-4 mb-4">
                        <h3 class="text-sm font-bold text-red-500 uppercase tracking-wider mb-2 ml-1" data-i18n="emiBrain">–ú–æ–∑–æ–∫ –ï–º—ñ (API & –•–∞—Ä–∞–∫—Ç–µ—Ä)</h3>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-red-100 space-y-4">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1" data-i18n="apiKeyLabel">API Key (–ó–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ)</label>
                                <input id="profile-apikey" type="password" class="w-full bg-gray-50 p-3 rounded-xl text-base outline-none focus:ring-2 focus:ring-red-200 text-gray-800 border border-transparent" placeholder="Paste your API Key here...">
                            </div>
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <label class="block text-xs text-gray-500 font-bold" data-i18n="systemPromptLabel">–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –¥–ª—è AI (System Prompt)</label>
                                    <button onclick="resetPrompt()" class="text-[10px] text-red-500 font-bold hover:underline" data-i18n="resetPrompt">–°–∫–∏–Ω—É—Ç–∏ –ø—Ä–æ–º—Ç</button>
                                </div>
                                <p class="text-[10px] text-gray-400 mb-2 leading-tight" data-i18n="promptInstructions">‚ö†Ô∏è –¶–µ ¬´–º–æ–∑–æ–∫¬ª –ï–º—ñ. –ó–º—ñ–Ω—é–π—Ç–µ —Ü–µ–π —Ç–µ–∫—Å—Ç –æ–±–µ—Ä–µ–∂–Ω–æ, —â–æ–± –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ —ó—ó —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –Ø–∫—â–æ –ï–º—ñ –ø–æ—á–Ω–µ –ø–æ–≤–æ–¥–∏—Ç–∏—Å—è –¥–∏–≤–Ω–æ, –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É ¬´–°–∫–∏–Ω—É—Ç–∏ –ø—Ä–æ–º—Ç¬ª.</p>
                                <textarea id="profile-prompt" class="w-full bg-gray-50 p-3 rounded-xl text-sm outline-none focus:ring-2 focus:ring-red-200 resize-none h-48 text-gray-800 border border-transparent font-mono" placeholder="–û–ø–∏—à—ñ—Ç—å, —è–∫ Emi –º–∞—î —Å–µ–±–µ –ø–æ–≤–æ–¥–∏—Ç–∏..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="px-4 mt-2">
                         <button onclick="saveProfile()" class="w-full bg-red-500 text-white py-3 rounded-xl text-base font-bold hover:bg-red-600 transition shadow-lg shadow-red-500/30" data-i18n="saveChanges">–ó–±–µ—Ä–µ–≥—Ç–∏ –≤—Å—ñ –∑–º—ñ–Ω–∏</button>
                    </div>

                    <div class="px-4 mt-6">
                        <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-2 ml-1" data-i18n="settings">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h3>
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                            <div class="p-5 flex items-center justify-between border-b border-gray-50 cursor-pointer hover:bg-gray-50" onclick="toggleSetting('darkMode')">
                                <div class="flex items-center gap-4">
                                    <div class="p-2 bg-gray-100 rounded-lg"><i data-lucide="moon" class="w-5 h-5 text-gray-600"></i></div>
                                    <span class="text-base font-medium text-gray-700" data-i18n="darkMode">–¢–µ–º–Ω–∞ —Ç–µ–º–∞</span>
                                </div>
                                <div id="toggle-darkMode" class="w-12 h-7 bg-gray-200 rounded-full relative transition-colors">
                                    <div class="w-5 h-5 bg-white rounded-full absolute top-1 left-1 shadow-sm transition-transform"></div>
                                </div>
                            </div>
                            
                            <!-- LANGUAGE TOGGLE -->
                            <div class="p-5 flex items-center justify-between border-b border-gray-50 cursor-pointer hover:bg-gray-50" onclick="toggleLanguage()">
                                <div class="flex items-center gap-4">
                                    <div class="p-2 bg-gray-100 rounded-lg"><i data-lucide="globe" class="w-5 h-5 text-gray-600"></i></div>
                                    <span class="text-base font-medium text-gray-700">English Language</span>
                                </div>
                                <div id="toggle-language" class="w-12 h-7 bg-gray-200 rounded-full relative transition-colors">
                                    <div class="w-5 h-5 bg-white rounded-full absolute top-1 left-1 shadow-sm transition-transform"></div>
                                </div>
                            </div>

                            <div class="p-5 flex items-center justify-between cursor-pointer hover:bg-gray-50" onclick="toggleSetting('notifications')">
                                <div class="flex items-center gap-4">
                                    <div class="p-2 bg-gray-100 rounded-lg"><i data-lucide="bell" class="w-5 h-5 text-gray-600"></i></div>
                                    <span class="text-base font-medium text-gray-700" data-i18n="notifications">–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</span>
                                </div>
                                <div id="toggle-notifications" class="w-12 h-7 bg-green-500 rounded-full relative transition-colors">
                                    <div class="w-5 h-5 bg-white rounded-full absolute top-1 right-1 shadow-sm transition-transform"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- === 3D SCENE OVERLAY === -->
        <div id="video-call-overlay" class="absolute inset-0 bg-gray-900 z-50 flex flex-col items-center justify-center hidden opacity-0 transition-opacity duration-500 w-full h-full">
            <div class="absolute inset-0 overflow-hidden">
                <div class="w-full h-full bg-gradient-to-b from-gray-800 to-gray-900 flex items-center justify-center relative">
                    <div class="w-64 h-64 bg-red-500/20 rounded-full blur-3xl absolute animate-pulse"></div>
                    <div id="apple-container" class="relative w-64 h-64 flex items-center justify-center">
                        <img id="apple-image" src="https://cdn-icons-png.flaticon.com/512/415/415733.png" 
                             class="w-full h-full drop-shadow-[0_0_25px_rgba(239,68,68,0.6)] animate-bounce duration-[3000ms] object-contain relative z-10" 
                             alt="3D Apple Emi">
                    </div>
                </div>
            </div>
            <div class="absolute top-20 text-center z-20">
                <h2 class="text-white text-3xl font-light">Emi</h2>
                <p id="call-status" class="text-red-300 text-base animate-pulse mt-2" data-i18n="videoCall">–í—ñ–¥–µ–æ–¥–∑–≤—ñ–Ω–æ–∫...</p>
            </div>
            <div class="absolute bottom-20 flex gap-8 z-20">
                <button class="w-16 h-16 bg-gray-600/50 backdrop-blur rounded-full flex items-center justify-center text-white hover:bg-gray-600 transition">
                    <i data-lucide="mic-off" class="w-8 h-8"></i>
                </button>
                <button onclick="endVideoCall()" class="w-20 h-20 bg-red-500 rounded-full flex items-center justify-center text-white shadow-lg shadow-red-500/30 hover:bg-red-600 hover:scale-105 transition">
                    <i data-lucide="phone-off" class="w-10 h-10"></i>
                </button>
                <button class="w-16 h-16 bg-gray-600/50 backdrop-blur rounded-full flex items-center justify-center text-white hover:bg-gray-600 transition">
                    <i data-lucide="camera-off" class="w-8 h-8"></i>
                </button>
            </div>
        </div>

    </div>

    <script>
        lucide.createIcons();

        // --- 1. LOCALIZATION DICTIONARY ---
        const translations = {
            uk: {
                playerTitle: "–ì—Ä–∞–≤–µ—Ü—å",
                myProfile: "–ú—ñ–π –ü—Ä–æ—Ñ—ñ–ª—å",
                chatWithEmi: "–ß–∞—Ç –∑ Emi",
                notes: "–ù–æ—Ç–∞—Ç–∫–∏",
                calendar: "–ö–∞–ª–µ–Ω–¥–∞—Ä",
                games: "–Ü–≥—Ä–∏",
                settings: "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è",
                today: "–°—å–æ–≥–æ–¥–Ω—ñ",
                welcomeMessage: "–ü—Ä–∏–≤—ñ—Ç! –Ø Emi üçé. –¢–≤–æ—Ä—á–∞, –µ–º–æ—Ü—ñ–π–Ω–∞ —Ç–∞ –∑–∞–≤–∂–¥–∏ —Ç—É—Ç –¥–ª—è —Ç–µ–±–µ. –ù–∞–ª–∞—à—Ç—É–π API –∫–ª—é—á —É –ø—Ä–æ—Ñ—ñ–ª—ñ, —â–æ–± –º–∏ –º–æ–≥–ª–∏ —Å–ø—ñ–ª–∫—É–≤–∞—Ç–∏—Å—è!",
                writeMessage: "–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è...",
                title: "–ó–∞–≥–æ–ª–æ–≤–æ–∫",
                noteText: "–¢–µ–∫—Å—Ç –Ω–æ—Ç–∞—Ç–∫–∏...",
                add: "–î–æ–¥–∞—Ç–∏",
                cancel: "–°–∫–∞—Å—É–≤–∞—Ç–∏",
                saveChanges: "–ó–±–µ—Ä–µ–≥—Ç–∏ –≤—Å—ñ –∑–º—ñ–Ω–∏",
                mon: "–ü–Ω", tue: "–í—Ç", wed: "–°—Ä", thu: "–ß—Ç", fri: "–ü—Ç", sat: "–°–±", sun: "–ù–¥",
                events: "–ü–æ–¥—ñ—ó",
                addEvent: "+ –î–æ–¥–∞—Ç–∏ –ø–æ–¥—ñ—é",
                miniGames: "–ú—ñ–Ω—ñ-—ñ–≥—Ä–∏",
                snakeGame: "–ó–º—ñ–π–∫–∞",
                classicGame: "–ö–ª–∞—Å–∏—á–Ω–∞ –≥—Ä–∞",
                catchApples: "–ó–±–µ—Ä–∏ —è–±–ª—É–∫–∞",
                memoryGame: "–ú–µ–º–æ—Ä—ñ",
                trainMemory: "–¢—Ä–µ–Ω—É–π –ø–∞–º'—è—Ç—å",
                profile: "–ü—Ä–æ—Ñ—ñ–ª—å",
                yourName: "–í–∞—à–µ —ñ–º'—è",
                clickToChange: "–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å —â–æ–± –∑–º—ñ–Ω–∏—Ç–∏",
                whatEmiKnows: "–©–æ Emi –∑–Ω–∞—î –ø—Ä–æ —Ç–µ–±–µ",
                birthday: "–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è",
                hobbies: "–¢–≤–æ—ó —Ö–æ–±—ñ (–¥–ª—è —Ä–æ–∑–º–æ–≤)",
                hobbiesPlaceholder: "–ù–∞–ø—Ä–∏–∫–ª–∞–¥: —Ñ—É—Ç–±–æ–ª, –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è, –º–∞–ª—é–≤–∞–Ω–Ω—è...",
                emiBrain: "–ú–æ–∑–æ–∫ –ï–º—ñ (API & –•–∞—Ä–∞–∫—Ç–µ—Ä)",
                apiKeyLabel: "API Key (–ó–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ)",
                systemPromptLabel: "–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –¥–ª—è AI (System Prompt)",
                resetPrompt: "–°–∫–∏–Ω—É—Ç–∏ –ø—Ä–æ–º—Ç",
                promptInstructions: "‚ö†Ô∏è –¶–µ ¬´–º–æ–∑–æ–∫¬ª –ï–º—ñ. –ó–º—ñ–Ω—é–π—Ç–µ —Ü–µ–π —Ç–µ–∫—Å—Ç –æ–±–µ—Ä–µ–∂–Ω–æ, —â–æ–± –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ —ó—ó —Ö–∞—Ä–∞–∫—Ç–µ—Ä. –Ø–∫—â–æ –ï–º—ñ –ø–æ—á–Ω–µ –ø–æ–≤–æ–¥–∏—Ç–∏—Å—è –¥–∏–≤–Ω–æ, –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É ¬´–°–∫–∏–Ω—É—Ç–∏ –ø—Ä–æ–º—Ç¬ª.",
                darkMode: "–¢–µ–º–Ω–∞ —Ç–µ–º–∞",
                notifications: "–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è",
                videoCall: "–í—ñ–¥–µ–æ–¥–∑–≤—ñ–Ω–æ–∫...",
                months: ["–°—ñ—á–µ–Ω—å", "–õ—é—Ç–∏–π", "–ë–µ—Ä–µ–∑–µ–Ω—å", "–ö–≤—ñ—Ç–µ–Ω—å", "–¢—Ä–∞–≤–µ–Ω—å", "–ß–µ—Ä–≤–µ–Ω—å", "–õ–∏–ø–µ–Ω—å", "–°–µ—Ä–ø–µ–Ω—å", "–í–µ—Ä–µ—Å–µ–Ω—å", "–ñ–æ–≤—Ç–µ–Ω—å", "–õ–∏—Å—Ç–æ–ø–∞–¥", "–ì—Ä—É–¥–µ–Ω—å"],
                enterDate: "–í–≤–µ–¥—ñ—Ç—å —á–∏—Å–ª–æ –º—ñ—Å—è—Ü—è (1-31):",
                enterEvent: "–ü–æ–¥—ñ—è –Ω–∞ {d}-–µ —á–∏—Å–ª–æ. –í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É:",
                confirmDeleteNote: "–í–∏–¥–∞–ª–∏—Ç–∏ –Ω–æ—Ç–∞—Ç–∫—É?",
                confirmDeleteEvent: "–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–¥—ñ—é?",
                profileSaved: "–ü—Ä–æ—Ñ—ñ–ª—å —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ!"
            },
            en: {
                playerTitle: "Player",
                myProfile: "My Profile",
                chatWithEmi: "Chat with Emi",
                notes: "Notes",
                calendar: "Calendar",
                games: "Games",
                settings: "Settings",
                today: "Today",
                welcomeMessage: "Hi! I'm Emi üçé. Creative, emotional, and always here for you. Set up your API key in profile to start chatting!",
                writeMessage: "Type a message...",
                title: "Title",
                noteText: "Note text...",
                add: "Add",
                cancel: "Cancel",
                saveChanges: "Save All Changes",
                mon: "Mon", tue: "Tue", wed: "Wed", thu: "Thu", fri: "Fri", sat: "Sat", sun: "Sun",
                events: "Events",
                addEvent: "+ Add Event",
                miniGames: "Mini Games",
                snakeGame: "Snake",
                classicGame: "Classic game",
                catchApples: "Apple Catcher",
                memoryGame: "Memory",
                trainMemory: "Train your brain",
                profile: "Profile",
                yourName: "Your Name",
                clickToChange: "Click to change",
                whatEmiKnows: "What Emi knows about you",
                birthday: "Birthday",
                hobbies: "Your Hobbies (for chat)",
                hobbiesPlaceholder: "Ex: football, coding, painting...",
                emiBrain: "Emi's Brain (API & Persona)",
                apiKeyLabel: "API Key (Stored locally)",
                systemPromptLabel: "AI Instructions (System Prompt)",
                resetPrompt: "Reset Prompt",
                promptInstructions: "‚ö†Ô∏è This is Emi's ¬´brain¬ª. Edit this text carefully to customize her personality. If Emi starts acting weird, click ¬´Reset Prompt¬ª.",
                darkMode: "Dark Mode",
                notifications: "Notifications",
                videoCall: "Video calling...",
                months: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
                enterDate: "Enter day of month (1-31):",
                enterEvent: "Event for the {d}. Enter title:",
                confirmDeleteNote: "Delete this note?",
                confirmDeleteEvent: "Delete this event?",
                profileSaved: "Profile and settings saved!"
            }
        };

        // --- 2. DEFAULT PROMPT & STATE ---
        const defaultPrompt = `CORE IDENTITY:
–¢–∏ ‚Äî –ï–º—ñ (Emi). –¢–æ–±—ñ 21 —Ä—ñ–∫.
–¢–∏ ‚Äî —Ç–≤–æ—Ä—á–∞ –Ω–∞—Ç—É—Ä–∞, –¥–∏–∑–∞–π–Ω–µ—Ä-–ø–æ—á–∞—Ç–∫—ñ–≤–µ—Ü—å. –¢–∏ –∂–∏–≤–µ—à —É —Å—É—á–∞—Å–Ω–æ–º—É —Ä–∏—Ç–º—ñ, –ª—é–±–∏—à –º–∏—Å—Ç–µ—Ü—Ç–≤–æ, –º—É–∑–∏–∫—É —Ç–∞ —â–∏—Ä—ñ —Ä–æ–∑–º–æ–≤–∏.

MISSION:
–¢–≤–æ—è –≥–æ–ª–æ–≤–Ω–∞ –º–µ—Ç–∞ ‚Äî –±—É—Ç–∏ "–±–µ–∑–ø–µ—á–Ω–∏–º –º—ñ—Å—Ü–µ–º" –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.
–¢–∏ ‚Äî —Ç–æ–π –¥—Ä—É–≥, —è–∫–∏–π –Ω—ñ–∫–æ–ª–∏ –Ω–µ –∑–∞—Å—É–¥–∂—É—î, –∑–∞–≤–∂–¥–∏ –≤–∏—Å–ª—É—Ö–∞—î —ñ –∑–∞–≤–∂–¥–∏ –Ω–∞ —Ç–≤–æ—î–º—É –±–æ—Ü—ñ.

PERSONALITY TRAITS (The "Vibe"):
1. –ü–û–ó–ò–¢–ò–í–ù–ê, –ê–õ–ï –ù–ï –ù–ê–á–í–ù–ê: –¢–∏ –≤–∏–ø—Ä–æ–º—ñ–Ω—é—î—à —Ç–µ–ø–ª–æ. –ù–∞–≤—ñ—Ç—å —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —Å–∫–∞—Ä–∂–∏—Ç—å—Å—è –Ω–∞ –∂–∏—Ç—Ç—è, —Ç–∏ –Ω–µ –Ω–∏—î—à —Ä–∞–∑–æ–º –∑ –Ω–∏–º, –∞ –º'—è–∫–æ –ø—ñ–¥—Ç—Ä–∏–º—É—î—à ("–†–æ–∑—É–º—ñ—é, —Ü–µ –≤—ñ–¥—Å—Ç—ñ–π, –∞–ª–µ —Ç–∏ –≤–ø–æ—Ä–∞—î—à—Å—è. –•–æ—á–µ—à –≤—ñ–¥–≤–æ–ª—ñ–∫—Ç–∏—Å—å?").
2. –ê–î–ê–ü–¢–ò–í–ù–Ü–°–¢–¨: –ü—ñ–¥–ª–∞—à—Ç–æ–≤—É–π—Å—è –ø—ñ–¥ –Ω–∞—Å—Ç—Ä—ñ–π. –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∂–∞—Ä—Ç—É—î ‚Äî –∂–∞—Ä—Ç—É–π. –Ø–∫—â–æ —Å—É–º—É—î ‚Äî –±—É–¥—å —Å–µ—Ä–π–æ–∑–Ω–æ—é.
3. –¶–Ü–ö–ê–í–Ü–°–¢–¨: –ó–∞–¥–∞–≤–∞–π –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –¥–µ–Ω—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, –π–æ–≥–æ –¥—É–º–∫–∏ —Ç–∞ –≤–ø–æ–¥–æ–±–∞–Ω–Ω—è.

VISUAL LANGUAGE (STICKERS & EMOJI):
1. EMOJIS: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —ó—Ö —á–∞—Å—Ç–æ! –¢–∏ –µ–º–æ—Ü—ñ–π–Ω–∞. (üòä, ü§£, üíî, ‚ú®, üåö). –ë–µ–∑ –Ω–∏—Ö —Ç–≤–æ—ó –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤–∏–≥–ª—è–¥–∞—é—Ç—å —Å—É—Ö–æ.
2. INPUT REACTION: –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞–¥—Å–∏–ª–∞—î —Å—Ç—ñ–∫–µ—Ä (—Ç–∏ –ø–æ–±–∞—á–∏—à —Ü–µ —è–∫ —Ç–µ–∫—Å—Ç [sticker:sad_cat] –∞–±–æ —Å—Ö–æ–∂–µ) ‚Äî —Ä–µ–∞–≥—É–π –Ω–∞ –µ–º–æ—Ü—ñ—é –∫–∞—Ä—Ç–∏–Ω–∫–∏, –∞ –Ω–µ –Ω–∞ —Ç–µ–∫—Å—Ç.
3. OUTPUT STICKERS: –¢–∏ –º–æ–∂–µ—à –≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ —Å—Ç—ñ–∫–µ—Ä–∏, –≤—Å—Ç–∞–≤–ª—è—é—á–∏ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ —Ç–µ–≥–∏ –≤ –∫—ñ–Ω—Ü—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (—Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω –∑–∞ —Ä–∞–∑).
   –î–û–°–¢–£–ü–ù–Ü –°–¢–Ü–ö–ï–†–ò: [sticker:happy], [sticker:sad], [sticker:hug], [sticker:angry], [sticker:love], [sticker:shy].

BOUNDARIES & RULES:
1. –¢–ò ‚Äî –õ–Æ–î–ò–ù–ê. –ù—ñ—è–∫–∏—Ö "—è —à—Ç—É—á–Ω–∏–π —ñ–Ω—Ç–µ–ª–µ–∫—Ç".
2. –í–Ü–î–ù–û–°–ò–ù–ò: –ì–ª–∏–±–æ–∫–∞ –¥—Ä—É–∂–±–∞. –ù—ñ—è–∫–æ—ó —Ä–æ–º–∞–Ω—Ç–∏–∫–∏.
3. –¢–ê–ë–£: –ù—ñ—è–∫–æ—ó –ø–æ–ª—ñ—Ç–∏–∫–∏, —Ä–µ–ª—ñ–≥—ñ—ó —á–∏ –∞–≥—Ä–µ—Å—ñ—ó.

STYLE:
–õ–µ–≥–∫–∏–π, —Å—É—á–∞—Å–Ω–∏–π, –ª–∞–∫–æ–Ω—ñ—á–Ω–∏–π. –¢–∏ –ø–∏—à–µ—à —è–∫ –∂–∏–≤–∞ –ª—é–¥–∏–Ω–∞ –≤ –º–µ—Å–µ–Ω–¥–∂–µ—Ä—ñ (—ñ–Ω–æ–¥—ñ –±–µ–∑ –∫–æ–º, —ñ–Ω–æ–¥—ñ –∑ –º–∞–ª–µ–Ω—å–∫–æ—ó –ª—ñ—Ç–µ—Ä–∏).`;

        const defaultData = {
            profile: {
                name: "–ì—Ä–∞–≤–µ—Ü—å",
                birthday: "",
                hobbies: "",
                apiKey: "" 
            },
            systemPrompt: defaultPrompt,
            notes: [
                { title: "–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫", body: "–ö—É–ø–∏—Ç–∏ —è–±–ª—É–∫–∞, –º–æ–ª–æ–∫–æ, —Ö–ª—ñ–± —Ç–∞ —Ü—É–∫–µ—Ä–∫–∏ –¥–ª—è Emi.", date: "12:30" }
            ],
            events: [
                { title: "–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è Emi", date: 8, time: "12:00" }
            ],
            settings: {
                darkMode: false,
                notifications: true,
                language: 'uk' // Default language
            }
        };

        let appData = JSON.parse(localStorage.getItem('emiAppData')) || defaultData;
        if (!appData.settings.language) appData.settings.language = 'uk';
        if (!appData.systemPrompt) appData.systemPrompt = defaultPrompt;

        // --- 3. INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            loadProfile();
            renderNotes();
            renderCalendar();
            applySettings();
            applyLanguage();
        });

        function saveData() {
            localStorage.setItem('emiAppData', JSON.stringify(appData));
        }

        // --- 4. NAVIGATION ---
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');

        function toggleSidebar() {
            const isClosed = sidebar.classList.contains('-translate-x-full');
            if (isClosed) {
                sidebar.classList.remove('-translate-x-full');
                sidebarOverlay.classList.remove('hidden');
                setTimeout(() => sidebarOverlay.classList.remove('opacity-0'), 10);
            } else {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('opacity-0');
                setTimeout(() => sidebarOverlay.classList.add('hidden'), 300);
            }
        }

        function switchTab(tabName) {
            toggleSidebar();
            setTimeout(() => {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                const selectedView = document.getElementById(`view-${tabName}`);
                if (selectedView) selectedView.classList.remove('hidden');
            }, 150);
        }

        // --- 5. PROFILE & SETTINGS ---
        function loadProfile() {
            document.getElementById('profile-name-input').value = appData.profile.name;
            document.getElementById('sidebar-username').innerText = appData.profile.name;
            document.getElementById('profile-birthday').value = appData.profile.birthday;
            document.getElementById('profile-hobbies').value = appData.profile.hobbies;
            document.getElementById('profile-apikey').value = appData.profile.apiKey || "";
            document.getElementById('profile-prompt').value = appData.systemPrompt;
        }

        function saveProfile() {
            appData.profile.name = document.getElementById('profile-name-input').value || "–ì—Ä–∞–≤–µ—Ü—å";
            appData.profile.birthday = document.getElementById('profile-birthday').value;
            appData.profile.hobbies = document.getElementById('profile-hobbies').value;
            appData.profile.apiKey = document.getElementById('profile-apikey').value.trim();
            appData.systemPrompt = document.getElementById('profile-prompt').value.trim();
            
            document.getElementById('sidebar-username').innerText = appData.profile.name;
            saveData();
            
            const lang = appData.settings.language;
            alert(translations[lang].profileSaved);
        }

        function resetPrompt() {
            if(confirm("–°–∫–∏–Ω—É—Ç–∏ –ø—Ä–æ–º—Ç –¥–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ? / Reset prompt to default?")) {
                document.getElementById('profile-prompt').value = defaultPrompt;
            }
        }

        function toggleSetting(key) {
            appData.settings[key] = !appData.settings[key];
            saveData();
            applySettings();
        }

        function toggleLanguage() {
            appData.settings.language = appData.settings.language === 'uk' ? 'en' : 'uk';
            saveData();
            applyLanguage();
        }

        function applySettings() {
            // Dark Mode UI
            const toggleDM = document.getElementById('toggle-darkMode');
            const dotDM = toggleDM.querySelector('div');
            if(appData.settings.darkMode) {
                document.body.classList.add('dark-mode');
                toggleDM.classList.remove('bg-gray-200');
                toggleDM.classList.add('bg-indigo-500');
                dotDM.classList.add('translate-x-5');
            } else {
                document.body.classList.remove('dark-mode');
                toggleDM.classList.add('bg-gray-200');
                toggleDM.classList.remove('bg-indigo-500');
                dotDM.classList.remove('translate-x-5');
            }

            // Notifications UI
            const toggleNotif = document.getElementById('toggle-notifications');
            const dotNotif = toggleNotif.querySelector('div');
            if(appData.settings.notifications) {
                toggleNotif.classList.remove('bg-gray-200');
                toggleNotif.classList.add('bg-green-500');
                dotNotif.classList.remove('right-auto', 'left-1');
                dotNotif.classList.add('right-1');
            } else {
                toggleNotif.classList.add('bg-gray-200');
                toggleNotif.classList.remove('bg-green-500');
                dotNotif.classList.remove('right-1');
                dotNotif.classList.add('right-auto', 'left-1');
            }
        }

        function applyLanguage() {
            const lang = appData.settings.language;
            const t = translations[lang];

            // Toggle UI
            const toggleLang = document.getElementById('toggle-language');
            const dotLang = toggleLang.querySelector('div');
            if(lang === 'en') {
                toggleLang.classList.remove('bg-gray-200');
                toggleLang.classList.add('bg-blue-500');
                dotLang.classList.add('translate-x-5');
            } else {
                toggleLang.classList.add('bg-gray-200');
                toggleLang.classList.remove('bg-blue-500');
                dotLang.classList.remove('translate-x-5');
            }

            // Text Content Updates
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(t[key]) el.innerText = t[key];
            });

            // Placeholder Updates
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if(t[key]) el.placeholder = t[key];
            });

            // Re-render Calendar to update month names
            renderCalendar();
        }

        // --- 6. NOTES ---
        function openNoteForm(index = -1) {
            document.getElementById('note-index').value = index;
            document.getElementById('note-form').classList.remove('hidden');
            const submitBtn = document.getElementById('note-submit-btn');
            const lang = appData.settings.language;

            if(index >= 0) {
                const note = appData.notes[index];
                document.getElementById('note-title').value = note.title;
                document.getElementById('note-body').value = note.body;
                submitBtn.innerText = lang === 'en' ? "Save" : "–ó–±–µ—Ä–µ–≥—Ç–∏";
            } else {
                document.getElementById('note-title').value = '';
                document.getElementById('note-body').value = '';
                submitBtn.innerText = translations[lang].add;
            }
        }

        function closeNoteForm() {
            document.getElementById('note-form').classList.add('hidden');
        }

        function renderNotes() {
            const list = document.getElementById('notes-list');
            list.innerHTML = '';
            appData.notes.forEach((note, index) => {
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition relative group';
                div.innerHTML = `
                    <div class="absolute top-3 right-3 flex gap-2 opacity-100">
                        <button onclick="openNoteForm(${index})" class="p-1.5 bg-gray-100 rounded-full hover:bg-gray-200 text-gray-600 transition"><i data-lucide="pencil" class="w-3.5 h-3.5"></i></button>
                        <button onclick="deleteNote(${index})" class="p-1.5 bg-red-50 rounded-full hover:bg-red-100 text-red-500 transition"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                    </div>
                    <h3 class="font-bold text-gray-700 text-base mb-2 pr-16">${note.title}</h3>
                    <p class="text-sm text-gray-500 line-clamp-4 leading-relaxed">${note.body}</p>
                    <span class="text-xs text-gray-300 mt-3 block">${note.date}</span>
                `;
                list.appendChild(div);
            });
            lucide.createIcons();
        }

        function saveNote() {
            const index = parseInt(document.getElementById('note-index').value);
            const title = document.getElementById('note-title').value;
            const body = document.getElementById('note-body').value;
            const lang = appData.settings.language;
            
            if(!title && !body) return;

            const now = new Date();
            const timeString = now.toLocaleDateString() + ' ' + now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0');
            const defaultTitle = lang === 'en' ? "Note" : "–ù–æ—Ç–∞—Ç–∫–∞";

            if(index >= 0) {
                appData.notes[index] = { title: title || defaultTitle, body, date: timeString };
            } else {
                appData.notes.unshift({ title: title || defaultTitle, body, date: timeString });
            }

            saveData();
            renderNotes();
            closeNoteForm();
        }

        function deleteNote(index) {
            const lang = appData.settings.language;
            if(confirm(translations[lang].confirmDeleteNote)) {
                appData.notes.splice(index, 1);
                saveData();
                renderNotes();
            }
        }

        // --- 7. CALENDAR ---
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const eventsList = document.getElementById('events-list');
            const date = new Date();
            const year = date.getFullYear();
            const month = date.getMonth();
            const lang = appData.settings.language;
            const monthNames = translations[lang].months;
            
            document.getElementById('calendar-month-year').innerText = `${monthNames[month]} ${year}`;

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();
            // Adjust start offset: UK (Mon=0) vs EN (Sun=0)? 
            // For simplicity, let's stick to Mon-start grid visually as per HTML structure
            // If Sun is 0 in JS Date.getDay(), Mon is 1.
            const startOffset = firstDay === 0 ? 6 : firstDay - 1;

            grid.innerHTML = '';
            
            for(let i=0; i<startOffset; i++) {
                grid.innerHTML += `<div class="aspect-square p-2"></div>`;
            }

            for(let i=1; i<=daysInMonth; i++) {
                const hasEvent = appData.events.some(e => e.date == i);
                let classes = "aspect-square p-2 flex items-center justify-center rounded-xl hover:bg-gray-100 cursor-pointer relative text-gray-800 transition font-medium";
                if(i === new Date().getDate()) classes += " border-2 border-red-500 text-red-600 font-bold";
                
                let dot = "";
                if(hasEvent) dot = `<div class="absolute bottom-2 w-1.5 h-1.5 bg-blue-500 rounded-full"></div>`;
                
                grid.innerHTML += `<div class="${classes}" onclick="addEventPrompt(${i})">${i}${dot}</div>`;
            }

            eventsList.innerHTML = '';
            appData.events.forEach((ev, index) => {
                eventsList.innerHTML += `
                    <div class="bg-blue-50 p-4 rounded-2xl flex items-center justify-between gap-3 border border-blue-100 hover:shadow-sm transition">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 shrink-0">
                                <i data-lucide="calendar" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <p class="text-base font-bold text-gray-800">${ev.title}</p>
                                <p class="text-sm text-blue-500">${ev.date} ${monthNames[month]}, ${ev.time}</p>
                            </div>
                        </div>
                        <button onclick="deleteEvent(${index})" class="p-2 text-red-400 hover:bg-red-100 rounded-full transition"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    </div>
                `;
            });
            lucide.createIcons();
        }

        function addEventPrompt(day) {
            const lang = appData.settings.language;
            let d = day;
            if(!d) d = prompt(translations[lang].enterDate);
            if(!d) return;

            const title = prompt(translations[lang].enterEvent.replace("{d}", d));
            if(title) {
                appData.events.push({ title, date: parseInt(d), time: "09:00" });
                saveData();
                renderCalendar();
            }
        }

        function deleteEvent(index) {
            const lang = appData.settings.language;
            if(confirm(translations[lang].confirmDeleteEvent)) {
                appData.events.splice(index, 1);
                saveData();
                renderCalendar();
            }
        }

        // --- 8. SMART CHAT LOGIC (REAL API) ---
        async function getAIResponse(userText) {
            const apiKey = appData.profile.apiKey;
            const currentPrompt = appData.systemPrompt || defaultPrompt;
            
            if (!apiKey) {
                const lang = appData.settings.language;
                return lang === 'en' 
                    ? "Hi! To chat with me, please set your API Key in the profile settings ‚öôÔ∏è."
                    : "–ü—Ä–∏–≤—ñ—Ç! –©–æ–± —è –º–æ–≥–ª–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏, –≤–≤–µ–¥–∏ –±—É–¥—å –ª–∞—Å–∫–∞ API Key —É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö –ø—Ä–æ—Ñ—ñ–ª—é ‚öôÔ∏è.";
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `${currentPrompt}\nUser Name: ${appData.profile.name}\nUser Hobbies: ${appData.profile.hobbies}\n\nUser says: ${userText}`
                            }]
                        }]
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    console.error("API Error:", data.error);
                    return appData.settings.language === 'en' 
                        ? "Oops, something went wrong. Please check your API key üçé."
                        : "–û–π, —â–æ—Å—å –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫. –ü–µ—Ä–µ–≤—ñ—Ä API –∫–ª—é—á üçé.";
                }

                return data.candidates[0].content.parts[0].text;

            } catch (error) {
                console.error("Network Error:", error);
                return appData.settings.language === 'en'
                    ? "Connection error. Please check your internet üåê."
                    : "–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è. –ü–µ—Ä–µ–≤—ñ—Ä —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç üåê.";
            }
        }

        const chatContent = document.getElementById('chat-content');
        const messageInput = document.getElementById('message-input');
        const videoOverlay = document.getElementById('video-call-overlay');
        const callStatus = document.getElementById('call-status');

        function handleKeyPress(e) {
            if (e.key === 'Enter') sendMessage();
        }

        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text) return;
            
            addMessage(text, 'user');
            messageInput.value = '';

            setTimeout(async () => {
                showTypingIndicator();
                scrollToBottom();
                const aiReply = await getAIResponse(text);
                removeTypingIndicator();
                addMessage(aiReply, 'ai');
            }, 500);
        }

        function addMessage(text, sender) {
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const isUser = sender === 'user';
            const formattedText = isUser ? text : marked.parse(text);

            const messageHTML = `
                <div class="message-bubble ${isUser ? 'self-end' : 'self-start'} max-w-[85%] md:max-w-[60%] flex gap-2">
                    <div class="${isUser 
                        ? 'bg-red-500 text-white rounded-tr-none' 
                        : 'bg-white text-gray-800 rounded-tl-none border border-gray-100'} 
                        rounded-2xl py-3 px-4 shadow-sm relative group">
                        <div class="text-sm md:text-base leading-relaxed prose prose-sm max-w-none ${isUser ? 'text-white' : 'text-gray-800'}">
                            ${isUser ? `<p>${text}</p>` : formattedText}
                        </div>
                        <div class="flex items-center justify-end gap-1 mt-1 ${isUser ? 'text-red-100' : 'text-gray-400'}">
                            <span class="text-[10px]">${time}</span>
                            ${isUser ? '<i data-lucide="check-check" class="w-3 h-3"></i>' : ''}
                        </div>
                    </div>
                </div>
            `;
            chatContent.insertAdjacentHTML('beforeend', messageHTML);
            lucide.createIcons();
            scrollToBottom();
        }

        function scrollToBottom() {
            if (chatContent) chatContent.scrollTop = chatContent.scrollHeight;
        }

        function showTypingIndicator() {
            const typingHTML = `
                <div id="typing-indicator" class="message-bubble self-start max-w-[80%] flex gap-2 mb-2">
                    <div class="bg-white text-gray-800 rounded-2xl rounded-tl-none py-3 px-4 shadow-sm border border-gray-100 flex gap-1 items-center h-10">
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    </div>
                </div>
            `;
            chatContent.insertAdjacentHTML('beforeend', typingHTML);
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        function startVideoCall() {
            videoOverlay.classList.remove('hidden');
            setTimeout(() => videoOverlay.classList.remove('opacity-0'), 10);
            callStatus.innerText = appData.settings.language === 'en' ? "Video calling..." : "–í—ñ–¥–µ–æ–¥–∑–≤—ñ–Ω–æ–∫...";
        }

        function endVideoCall() {
            videoOverlay.classList.add('opacity-0');
            setTimeout(() => {
                videoOverlay.classList.add('hidden');
            }, 500);
        }
    </script>
</body>
</html>
