<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <!-- Viewport fix for mobile notch and bars -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Settings (Full Screen Mode) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Emi AI">
    <meta name="theme-color" content="#ffffff">

    <title>Emi AI Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --primary: #9333ea;
            --primary-dark: #7e22ce;
            --primary-light: #f3e8ff;
            --accent: #d8b4fe;
            --bg-pattern: #faf5ff;
        }

        /* Themes */
        body[data-theme="grape"] { --primary: #9333ea; --primary-dark: #7e22ce; --primary-light: #f3e8ff; --accent: #d8b4fe; --bg-pattern: #faf5ff; }
        body[data-theme="apple"] { --primary: #ef4444; --primary-dark: #dc2626; --primary-light: #fef2f2; --accent: #fca5a5; --bg-pattern: #fff1f2; }
        body[data-theme="mandarin"] { --primary: #f97316; --primary-dark: #ea580c; --primary-light: #ffedd5; --accent: #fdba74; --bg-pattern: #fff7ed; }
        body[data-theme="kiwi"] { --primary: #65a30d; --primary-dark: #4d7c0f; --primary-light: #ecfccb; --accent: #bef264; --bg-pattern: #f7fee7; }
        body[data-theme="blueberry"] { --primary: #2563eb; --primary-dark: #1d4ed8; --primary-light: #eff6ff; --accent: #93c5fd; --bg-pattern: #f0f9ff; }

        /* Mobile Fixes */
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        
        /* 100dvh fixes the mobile browser bar issue */
        .full-mobile-height { height: 100vh; height: 100dvh; }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(0, 0, 0, 0.1); border-radius: 20px; }
        
        @keyframes popIn {
            0% { opacity: 0; transform: translateY(10px) scale(0.95); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        .message-bubble { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        .app-bg {
            background-color: var(--bg-pattern);
            background-image: radial-gradient(var(--primary) 0.5px, transparent 0.5px), radial-gradient(var(--primary) 0.5px, var(--bg-pattern) 0.5px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            transition: background-color 0.3s, background-image 0.3s;
        }
        body.dark-mode .app-bg {
            background-color: #111827;
            background-image: radial-gradient(#374151 0.5px, transparent 0.5px), radial-gradient(#374151 0.5px, #111827 0.5px);
        }

        .bg-theme-primary { background-color: var(--primary); transition: background-color 0.3s; }
        .bg-theme-dark { background-color: var(--primary-dark); transition: background-color 0.3s; }
        .bg-theme-light { background-color: var(--primary-light); transition: background-color 0.3s; }
        .text-theme-primary { color: var(--primary); transition: color 0.3s; }
        .border-theme-light { border-color: var(--primary-light); transition: border-color 0.3s; }
        
        .tab-content { transition: opacity 0.2s ease-in-out; }
        .tab-content.hidden { display: none; opacity: 0; }
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; }

        /* Dark Mode */
        body.dark-mode { background-color: #111827; color: #f3f4f6; }
        body.dark-mode .bg-white { background-color: #1f2937; color: #f3f4f6; border-color: #374151; }
        body.dark-mode .bg-gray-50 { background-color: #111827; }
        body.dark-mode .bg-gray-100 { background-color: #374151; }
        body.dark-mode .bg-theme-light { background-color: #374151; color: #e5e7eb; border-color: #4b5563; }
        body.dark-mode .text-gray-800 { color: #f9fafb; }
        body.dark-mode .text-gray-700 { color: #e5e7eb; }
        body.dark-mode .text-gray-600 { color: #d1d5db; }
        body.dark-mode .text-gray-500 { color: #9ca3af; }
        body.dark-mode .border-gray-100 { border-color: #374151; }
        body.dark-mode .border-gray-200 { border-color: #4b5563; }
        body.dark-mode input, body.dark-mode textarea { background-color: #374151; color: white; border-color: #4b5563; }
        body.dark-mode #sidebar { background-color: #1f2937; border-right: 1px solid #374151; }

        /* Safe Area for iPhone X+ */
        .pt-safe { padding-top: env(safe-area-inset-top, 20px); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
    </style>
</head>
<body class="bg-gray-50 full-mobile-height w-screen overflow-hidden font-sans text-gray-800" data-theme="grape">

    <!-- App Container -->
    <div class="relative w-full h-full flex flex-col bg-white transition-colors duration-300">
        
        <!-- SIDEBAR -->
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="absolute inset-0 bg-black/50 z-40 hidden opacity-0"></div>
        <aside id="sidebar" class="absolute top-0 left-0 bottom-0 w-[300px] bg-white z-50 transform -translate-x-full shadow-2xl flex flex-col transition-colors duration-300 h-full">
            <div class="h-[160px] bg-theme-primary p-5 pt-safe flex flex-col justify-end text-white relative overflow-hidden shrink-0">
                <div class="absolute -top-10 -right-10 w-32 h-32 bg-white/10 rounded-full"></div>
                <div class="absolute top-10 right-10 w-10 h-10 bg-white/10 rounded-full"></div>
                <div class="w-16 h-16 bg-white rounded-full mb-3 flex items-center justify-center text-3xl shadow-sm border-2 border-white/30 cursor-pointer hover:scale-105 transition overflow-hidden text-gray-800" onclick="switchTab('profile')">üë§</div>
                <div id="sidebar-username" class="font-bold text-lg leading-none">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</div>
                <div class="text-sm text-white/80 mt-1" data-i18n="playerTitle">–ì—Ä–∞–≤–µ—Ü—å</div>
            </div>
            <nav class="flex-1 overflow-y-auto py-2">
                <button onclick="switchTab('profile')" class="w-full flex items-center gap-4 px-5 py-3 text-gray-700 hover:bg-gray-100 active:bg-gray-200 transition"><i data-lucide="user" class="w-5 h-5 text-gray-500"></i><span class="font-medium" data-i18n="myProfile">–ú—ñ–π –ü—Ä–æ—Ñ—ñ–ª—å</span></button>
                <div class="border-b border-gray-100 my-1"></div>
                <button onclick="switchTab('chat')" class="w-full flex items-center gap-4 px-5 py-3 text-gray-700 hover:bg-gray-100 active:bg-gray-200 transition"><i data-lucide="message-circle" class="w-5 h-5 text-gray-500"></i><div class="flex-1 text-left font-medium" data-i18n="chatWithEmi">–ß–∞—Ç –∑ Emi</div><span class="bg-theme-primary text-white text-[10px] font-bold px-1.5 rounded-full">1</span></button>
                <button onclick="switchTab('notes')" class="w-full flex items-center gap-4 px-5 py-3 text-gray-700 hover:bg-gray-100 active:bg-gray-200 transition"><i data-lucide="sticky-note" class="w-5 h-5 text-gray-500"></i><span class="font-medium" data-i18n="notes">–ù–æ—Ç–∞—Ç–∫–∏</span></button>
                <button onclick="switchTab('calendar')" class="w-full flex items-center gap-4 px-5 py-3 text-gray-700 hover:bg-gray-100 active:bg-gray-200 transition"><i data-lucide="calendar" class="w-5 h-5 text-gray-500"></i><span class="font-medium" data-i18n="calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä</span></button>
                <button onclick="switchTab('games')" class="w-full flex items-center gap-4 px-5 py-3 text-gray-700 hover:bg-gray-100 active:bg-gray-200 transition"><i data-lucide="gamepad-2" class="w-5 h-5 text-gray-500"></i><span class="font-medium" data-i18n="games">–Ü–≥—Ä–∏</span></button>
                <div class="border-b border-gray-100 my-1"></div>
                <button onclick="switchTab('settings')" class="w-full flex items-center gap-4 px-5 py-3 text-gray-700 hover:bg-gray-100 active:bg-gray-200 transition"><i data-lucide="settings" class="w-5 h-5 text-gray-500"></i><span class="font-medium" data-i18n="settings">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</span></button>
            </nav>
        </aside>

        <!-- CONTENT -->
        <div class="flex-1 overflow-hidden relative bg-white transition-colors duration-300 w-full h-full flex flex-col">
            <!-- CHAT -->
            <div id="view-chat" class="tab-content h-full flex flex-col w-full">
                <header class="bg-theme-primary text-white p-4 pt-safe flex items-center justify-between shadow-md z-10 shrink-0 h-[60px] md:h-[80px]">
                    <div class="flex items-center gap-4">
                        <button onclick="toggleSidebar()" class="p-1 hover:bg-white/20 rounded-full transition active:scale-95"><i data-lucide="menu" class="w-6 h-6"></i></button>
                        <div class="flex items-center gap-3">
                            <div class="relative"><div class="w-10 h-10 rounded-full bg-white/20 border-2 border-white/40 overflow-hidden flex items-center justify-center text-2xl emi-avatar-slot">üçá</div><div class="absolute bottom-0 right-0 w-3 h-3 bg-green-400 border-2 border-white rounded-full"></div></div>
                            <div class="flex flex-col"><h1 class="font-bold text-lg leading-none">Emi</h1><p class="text-xs text-white/80 mt-0.5">Online</p></div>
                        </div>
                    </div>
                    <button onclick="startVideoCall()" class="p-2 hover:bg-white/20 rounded-full transition shadow-sm active:scale-95 group"><i data-lucide="video" class="w-5 h-5"></i></button>
                </header>
                <main id="chat-content" class="flex-1 app-bg overflow-y-auto custom-scrollbar p-4 flex flex-col gap-3 w-full max-w-5xl mx-auto">
                    <div class="flex justify-center my-2 opacity-60"><span class="bg-gray-200 text-gray-600 text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-wide shadow-sm" data-i18n="today">–°—å–æ–≥–æ–¥–Ω—ñ</span></div>
                    <div class="message-bubble self-start max-w-[85%] md:max-w-[60%] flex gap-2">
                        <div class="bg-white text-gray-800 rounded-2xl rounded-tl-none py-3 px-4 shadow-sm border border-gray-100">
                            <p class="text-sm md:text-base leading-relaxed" data-i18n="welcomeMessage">–ü—Ä–∏–≤—ñ—Ç! –Ø Emi. –Ø —Ç—É—Ç, —â–æ–± –º–∏ –º–æ–≥–ª–∏ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç–∏ –ø—Ä–æ –≤—Å–µ –Ω–∞ —Å–≤—ñ—Ç—ñ.</p>
                            <span class="text-[10px] text-gray-400 block text-right mt-1">10:00</span>
                        </div>
                    </div>
                </main>
                <div class="bg-white p-3 pb-safe border-t border-gray-100 shrink-0 flex items-center gap-2 z-10 w-full justify-center">
                    <div class="w-full max-w-5xl flex items-center gap-2">
                        <button class="p-2 text-gray-400 hover:text-theme-primary transition"><i data-lucide="plus" class="w-6 h-6"></i></button>
                        <div class="flex-1 bg-gray-100 rounded-full px-4 py-3 flex items-center">
                            <input type="text" id="message-input" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." class="w-full bg-transparent outline-none text-base text-gray-800 placeholder-gray-400" autocomplete="off" onkeypress="handleKeyPress(event)" data-i18n-placeholder="writeMessage">
                        </div>
                        <button onclick="sendMessage()" class="p-3 bg-theme-primary hover:bg-theme-dark text-white rounded-full shadow-md transition active:scale-95 flex items-center justify-center"><i data-lucide="send" class="w-5 h-5 ml-0.5"></i></button>
                    </div>
                </div>
            </div>

            <!-- NOTES -->
            <div id="view-notes" class="tab-content h-full flex flex-col hidden bg-gray-50 w-full">
                <header class="bg-white p-4 pt-safe border-b border-gray-200 shadow-sm h-[60px] md:h-[80px] flex items-center justify-between shrink-0"><div class="flex items-center gap-4"><button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 rounded-full transition text-gray-600"><i data-lucide="menu" class="w-6 h-6"></i></button><h1 class="font-bold text-2xl text-gray-800" data-i18n="notes">–ù–æ—Ç–∞—Ç–∫–∏</h1></div><button onclick="openNoteForm()" class="p-2 bg-theme-primary rounded-full text-white shadow-sm hover:opacity-90 transition"><i data-lucide="plus" class="w-5 h-5"></i></button></header>
                <div id="note-form" class="hidden p-4 bg-theme-light border-b border-gray-100 animate-fade-in shrink-0 w-full max-w-3xl mx-auto mt-4 rounded-xl shadow-sm"><input type="hidden" id="note-index" value="-1"><input type="text" id="note-title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" class="w-full mb-2 p-3 rounded border border-gray-200 text-base outline-none focus:ring-2 focus:ring-theme text-gray-800" data-i18n-placeholder="title"><textarea id="note-body" placeholder="–¢–µ–∫—Å—Ç –Ω–æ—Ç–∞—Ç–∫–∏..." class="w-full mb-2 p-3 rounded border border-gray-200 text-base outline-none focus:ring-2 focus:ring-theme text-gray-800 resize-none h-32" data-i18n-placeholder="noteText"></textarea><div class="flex gap-2"><button id="note-submit-btn" onclick="saveNote()" class="flex-1 bg-theme-primary text-white py-2 rounded text-sm font-bold hover:opacity-90" data-i18n="add">–î–æ–¥–∞—Ç–∏</button><button onclick="closeNoteForm()" class="px-4 bg-gray-200 text-gray-600 rounded text-sm hover:bg-gray-300" data-i18n="cancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button></div></div>
                <div id="notes-list" class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 overflow-y-auto custom-scrollbar w-full max-w-6xl mx-auto"></div>
            </div>

            <!-- CALENDAR -->
            <div id="view-calendar" class="tab-content h-full flex flex-col hidden bg-white w-full">
                <header class="bg-white p-4 pt-safe border-b border-gray-200 shadow-sm h-[60px] md:h-[80px] flex items-center justify-between shrink-0"><div class="flex items-center gap-4"><button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 rounded-full transition text-gray-600"><i data-lucide="menu" class="w-6 h-6"></i></button><h1 class="font-bold text-2xl text-gray-800" data-i18n="calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä</h1></div><span id="calendar-month-year" class="text-sm font-semibold text-theme-primary bg-theme-light px-3 py-1 rounded-full"></span></header>
                <div class="p-4 flex-1 overflow-y-auto w-full max-w-4xl mx-auto">
                    <div class="grid grid-cols-7 mb-2 text-center"><span class="text-xs font-bold text-gray-400" data-i18n="mon">–ü–Ω</span><span class="text-xs font-bold text-gray-400" data-i18n="tue">–í—Ç</span><span class="text-xs font-bold text-gray-400" data-i18n="wed">–°—Ä</span><span class="text-xs font-bold text-gray-400" data-i18n="thu">–ß—Ç</span><span class="text-xs font-bold text-gray-400" data-i18n="fri">–ü—Ç</span><span class="text-xs font-bold text-gray-400 text-theme-primary" data-i18n="sat">–°–±</span><span class="text-xs font-bold text-gray-400 text-theme-primary" data-i18n="sun">–ù–¥</span></div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center text-sm md:text-base"></div>
                    <div class="mt-8"><h3 class="font-bold text-gray-800 mb-4 flex justify-between items-center text-lg"><span data-i18n="events">–ü–æ–¥—ñ—ó</span><button onclick="addEventPrompt()" class="text-sm text-theme-primary font-medium px-3 py-1 bg-theme-light rounded-lg hover:opacity-80" data-i18n="addEvent">+ –î–æ–¥–∞—Ç–∏ –ø–æ–¥—ñ—é</button></h3><div id="events-list" class="space-y-3 pb-10 grid grid-cols-1 md:grid-cols-2 gap-4"></div></div>
                </div>
            </div>

            <!-- GAMES -->
            <div id="view-games" class="tab-content h-full flex flex-col hidden bg-gray-50 w-full">
                <header class="bg-white p-4 pt-safe border-b border-gray-200 shadow-sm h-[60px] md:h-[80px] flex items-center justify-between shrink-0"><div class="flex items-center gap-4"><button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 rounded-full transition text-gray-600"><i data-lucide="menu" class="w-6 h-6"></i></button><h1 class="font-bold text-2xl text-gray-800" data-i18n="miniGames">–ú—ñ–Ω—ñ-—ñ–≥—Ä–∏</h1></div><div class="bg-gray-100 px-3 py-1 rounded-full flex items-center gap-1"><i data-lucide="coins" class="w-4 h-4 text-yellow-500"></i><span id="coin-balance" class="text-xs font-bold text-gray-600">1250</span></div></header>
                <div class="p-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 overflow-y-auto custom-scrollbar w-full max-w-6xl mx-auto">
                    <div onclick="launchGame('snake')" class="bg-gradient-to-br from-gray-700 to-gray-900 p-6 rounded-2xl shadow-lg text-white aspect-[4/3] flex flex-col justify-between hover:scale-105 transition cursor-pointer"><i data-lucide="gamepad-2" class="w-10 h-10 opacity-80"></i><div><h3 class="font-bold text-lg" data-i18n="snakeGame">Snake</h3><p class="text-xs opacity-70" data-i18n="classicGame">–ö–ª–∞—Å–∏—á–Ω–∞ –≥—Ä–∞</p></div></div>
                    <div onclick="launchGame('catcher')" class="bg-gradient-to-br from-theme-primary to-theme-dark bg-theme-primary p-6 rounded-2xl shadow-lg text-white aspect-[4/3] flex flex-col justify-between hover:scale-105 transition cursor-pointer"><i data-lucide="shopping-basket" class="w-10 h-10 opacity-80"></i><div><h3 class="font-bold text-lg" data-i18n="catchApples">Catcher</h3><p class="text-xs opacity-70">–ó–±–µ—Ä–∏ —Ñ—Ä—É–∫—Ç–∏</p></div></div>
                    <div onclick="launchGame('memory')" class="bg-gradient-to-br from-blue-500 to-indigo-600 p-6 rounded-2xl shadow-lg text-white aspect-[4/3] flex flex-col justify-between hover:scale-105 transition cursor-pointer"><i data-lucide="brain-circuit" class="w-10 h-10 opacity-80"></i><div><h3 class="font-bold text-lg" data-i18n="memoryGame">–ú–µ–º–æ—Ä—ñ</h3><p class="text-xs opacity-70" data-i18n="trainMemory">–¢—Ä–µ–Ω—É–π –ø–∞–º'—è—Ç—å</p></div></div>
                    <div onclick="launchGame('minesweeper')" class="bg-gradient-to-br from-slate-600 to-slate-800 p-6 rounded-2xl shadow-lg text-white aspect-[4/3] flex flex-col justify-between hover:scale-105 transition cursor-pointer"><i data-lucide="bomb" class="w-10 h-10 opacity-80"></i><div><h3 class="font-bold text-lg" data-i18n="minesweeper">–°–∞–ø–µ—Ä</h3><p class="text-xs opacity-70">–û–±–µ—Ä–µ–∂–Ω–æ!</p></div></div>
                </div>
            </div>

            <!-- PROFILE -->
            <div id="view-profile" class="tab-content h-full flex flex-col hidden bg-gray-50 w-full">
                <header class="bg-white p-4 pt-safe border-b border-gray-200 shadow-sm h-[60px] md:h-[80px] flex items-center justify-between shrink-0"><div class="flex items-center gap-4"><button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 rounded-full transition text-gray-600"><i data-lucide="menu" class="w-6 h-6"></i></button><h1 class="font-bold text-2xl text-gray-800" data-i18n="profile">–ü—Ä–æ—Ñ—ñ–ª—å</h1></div></header>
                <div class="flex-1 overflow-y-auto custom-scrollbar pb-10 w-full max-w-3xl mx-auto">
                    <div class="bg-white m-4 p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center"><div class="w-24 h-24 bg-gray-200 rounded-full mb-4 flex items-center justify-center text-4xl text-gray-800">üë§</div><input id="profile-name-input" type="text" class="text-center font-bold text-2xl text-gray-800 border-b-2 border-transparent focus:border-theme-primary outline-none bg-transparent w-full" placeholder="–í–∞—à–µ —ñ–º'—è" data-i18n-placeholder="yourName"><p class="text-sm text-gray-400 mt-2" data-i18n="clickToChange">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å —â–æ–± –∑–º—ñ–Ω–∏—Ç–∏</p></div>
                    <div class="px-4 mb-4"><h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-2 ml-1" data-i18n="whatEmiKnows">–©–æ Emi –∑–Ω–∞—î –ø—Ä–æ —Ç–µ–±–µ</h3><div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 space-y-6"><div><label class="block text-sm text-gray-500 mb-2 font-medium" data-i18n="birthday">–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è</label><input id="profile-birthday" type="date" class="w-full bg-gray-50 p-3 rounded-xl text-base outline-none focus:ring-2 focus:ring-theme text-gray-800 border border-transparent"></div><div><label class="block text-sm text-gray-500 mb-2 font-medium" data-i18n="hobbies">–¢–≤–æ—ó —Ö–æ–±—ñ (–¥–ª—è —Ä–æ–∑–º–æ–≤)</label><textarea id="profile-hobbies" class="w-full bg-gray-50 p-3 rounded-xl text-base outline-none focus:ring-2 focus:ring-theme resize-none h-24 text-gray-800 border border-transparent" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: —Ñ—É—Ç–±–æ–ª, –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è, –º–∞–ª—é–≤–∞–Ω–Ω—è..." data-i18n-placeholder="hobbiesPlaceholder"></textarea></div></div></div>
                    <div class="px-4 mt-2"><button onclick="saveProfile()" class="w-full bg-theme-primary text-white py-3 rounded-xl text-base font-bold hover:opacity-90 transition shadow-lg shadow-theme/30" data-i18n="saveChanges">–ó–±–µ—Ä–µ–≥—Ç–∏ –≤—Å—ñ –∑–º—ñ–Ω–∏</button></div>
                </div>
            </div>

            <!-- SETTINGS -->
            <div id="view-settings" class="tab-content h-full flex flex-col hidden bg-gray-50 w-full">
                <header class="bg-white p-4 pt-safe border-b border-gray-200 shadow-sm h-[60px] md:h-[80px] flex items-center justify-between shrink-0"><div class="flex items-center gap-4"><button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 rounded-full transition text-gray-600"><i data-lucide="menu" class="w-6 h-6"></i></button><h1 class="font-bold text-2xl text-gray-800" data-i18n="settings">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h1></div></header>
                <div class="flex-1 overflow-y-auto custom-scrollbar pb-10 w-full max-w-3xl mx-auto pt-4">
                    <div class="px-4 mb-6"><h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-2 ml-1" data-i18n="generalSettings">–ó–∞–≥–∞–ª—å–Ω—ñ</h3><div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="p-5 border-b border-gray-50"><label class="block text-sm font-medium text-gray-700 mb-3" data-i18n="chooseTheme">–û–±–µ—Ä—ñ—Ç—å —Ç–µ–º—É</label><div class="flex gap-4 overflow-x-auto pb-2 custom-scrollbar"><button onclick="setTheme('grape')" class="flex flex-col items-center gap-2 group min-w-[60px]"><div class="w-12 h-12 rounded-full bg-purple-600 shadow-sm flex items-center justify-center text-xl border-2 border-transparent group-hover:scale-110 transition">üçá</div><span class="text-xs text-gray-500">Grape</span></button><button onclick="setTheme('apple')" class="flex flex-col items-center gap-2 group min-w-[60px]"><div class="w-12 h-12 rounded-full bg-red-500 shadow-sm flex items-center justify-center text-xl border-2 border-transparent group-hover:scale-110 transition">üçé</div><span class="text-xs text-gray-500">Apple</span></button><button onclick="setTheme('mandarin')" class="flex flex-col items-center gap-2 group min-w-[60px]"><div class="w-12 h-12 rounded-full bg-orange-500 shadow-sm flex items-center justify-center text-xl border-2 border-transparent group-hover:scale-110 transition">üçä</div><span class="text-xs text-gray-500">Mandarin</span></button><button onclick="setTheme('kiwi')" class="flex flex-col items-center gap-2 group min-w-[60px]"><div class="w-12 h-12 rounded-full bg-lime-600 shadow-sm flex items-center justify-center text-xl border-2 border-transparent group-hover:scale-110 transition">ü•ù</div><span class="text-xs text-gray-500">Kiwi</span></button><button onclick="setTheme('blueberry')" class="flex flex-col items-center gap-2 group min-w-[60px]"><div class="w-12 h-12 rounded-full bg-blue-600 shadow-sm flex items-center justify-center text-xl border-2 border-transparent group-hover:scale-110 transition">ü´ê</div><span class="text-xs text-gray-500">Blueberry</span></button></div></div>
                        <div class="p-5 flex items-center justify-between border-b border-gray-50 cursor-pointer hover:bg-gray-50" onclick="toggleSetting('darkMode')"><div class="flex items-center gap-4"><div class="p-2 bg-gray-100 rounded-lg"><i data-lucide="moon" class="w-5 h-5 text-gray-600"></i></div><span class="text-base font-medium text-gray-700" data-i18n="darkMode">–¢–µ–º–Ω–∞ —Ç–µ–º–∞</span></div><div id="toggle-darkMode" class="w-12 h-7 bg-gray-200 rounded-full relative transition-colors"><div class="w-5 h-5 bg-white rounded-full absolute top-1 left-1 shadow-sm transition-transform"></div></div></div>
                        <div class="p-5 flex items-center justify-between border-b border-gray-50 cursor-pointer hover:bg-gray-50" onclick="toggleLanguage()"><div class="flex items-center gap-4"><div class="p-2 bg-gray-100 rounded-lg"><i data-lucide="globe" class="w-5 h-5 text-gray-600"></i></div><span class="text-base font-medium text-gray-700">English Language</span></div><div id="toggle-language" class="w-12 h-7 bg-gray-200 rounded-full relative transition-colors"><div class="w-5 h-5 bg-white rounded-full absolute top-1 left-1 shadow-sm transition-transform"></div></div></div>
                        <div class="p-5 flex items-center justify-between cursor-pointer hover:bg-gray-50" onclick="toggleSetting('notifications')"><div class="flex items-center gap-4"><div class="p-2 bg-gray-100 rounded-lg"><i data-lucide="bell" class="w-5 h-5 text-gray-600"></i></div><span class="text-base font-medium text-gray-700" data-i18n="notifications">–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è</span></div><div id="toggle-notifications" class="w-12 h-7 bg-green-500 rounded-full relative transition-colors"><div class="w-5 h-5 bg-white rounded-full absolute top-1 right-1 shadow-sm transition-transform"></div></div></div>
                    </div></div>
                    <div class="px-4 mb-4"><h3 class="text-sm font-bold text-theme-primary uppercase tracking-wider mb-2 ml-1" data-i18n="emiBrain">–ú–æ–∑–æ–∫ –ï–º—ñ (API & –•–∞—Ä–∞–∫—Ç–µ—Ä)</h3><div class="bg-white p-6 rounded-2xl shadow-sm border border-theme-light space-y-4"><div><label class="block text-xs text-gray-500 mb-1" data-i18n="apiKeyLabel">API Key (–ó–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ)</label><input id="profile-apikey" type="password" class="w-full bg-gray-50 p-3 rounded-xl text-base outline-none focus:ring-2 focus:ring-theme text-gray-800 border border-transparent" placeholder="Paste your API Key here..."></div><div><div class="flex justify-between items-center mb-1"><label class="block text-xs text-gray-500 font-bold" data-i18n="systemPromptLabel">–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –¥–ª—è AI (System Prompt)</label><button onclick="resetPrompt()" class="text-[10px] text-theme-primary font-bold hover:underline" data-i18n="resetPrompt">–°–∫–∏–Ω—É—Ç–∏ –ø—Ä–æ–º—Ç</button></div><p class="text-[10px] text-gray-400 mb-2 leading-tight" data-i18n="promptInstructions">‚ö†Ô∏è –¶–µ ¬´–º–æ–∑–æ–∫¬ª –ï–º—ñ.</p><textarea id="profile-prompt" class="w-full bg-gray-50 p-3 rounded-xl text-sm outline-none focus:ring-2 focus:ring-theme resize-none h-48 text-gray-800 border border-transparent font-mono"></textarea></div><button onclick="saveProfile()" class="w-full bg-gray-900 text-white py-3 rounded-xl text-base font-bold hover:bg-gray-800 transition" data-i18n="saveChanges">–ó–±–µ—Ä–µ–≥—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button></div></div>
                </div>
            </div>
        </div>

        <!-- VIDEO OVERLAY -->
        <div id="video-call-overlay" class="absolute inset-0 bg-gray-900 z-50 flex flex-col items-center justify-center hidden opacity-0 transition-opacity duration-500 w-full h-full"><div class="absolute inset-0 overflow-hidden"><div class="w-full h-full bg-gradient-to-b from-gray-800 to-gray-900 flex items-center justify-center relative"><div class="w-64 h-64 bg-theme-primary opacity-20 rounded-full blur-3xl absolute animate-pulse"></div><div class="relative w-64 h-64 flex items-center justify-center text-9xl emi-avatar-slot animate-bounce">üçá</div></div></div><div class="absolute top-20 text-center z-20"><h2 class="text-white text-3xl font-light">Emi</h2><p id="call-status" class="text-theme-light text-base animate-pulse mt-2" data-i18n="videoCall">–í—ñ–¥–µ–æ–¥–∑–≤—ñ–Ω–æ–∫...</p></div><div class="absolute bottom-20 flex gap-8 z-20"><button onclick="endVideoCall()" class="w-20 h-20 bg-red-500 rounded-full flex items-center justify-center text-white shadow-lg transition hover:scale-105"><i data-lucide="phone-off" class="w-10 h-10"></i></button></div></div>

        <!-- GAME OVERLAY -->
        <div id="game-overlay" class="absolute inset-0 bg-gray-900 z-50 flex flex-col items-center justify-center hidden opacity-0 transition-opacity duration-500 w-full h-full font-mono"><button onclick="closeGame()" class="absolute top-6 right-6 p-2 bg-gray-800 rounded-full text-white z-50"><i data-lucide="x" class="w-6 h-6"></i></button><div id="game-container" class="relative w-full h-full flex flex-col items-center justify-center"><canvas id="game-canvas" class="bg-gray-800 border-4 border-gray-700 rounded-lg shadow-2xl hidden"></canvas><div id="memory-grid" class="grid grid-cols-4 gap-2 hidden p-4"></div><div id="minesweeper-ui" class="hidden flex-col items-center gap-4"><div id="minesweeper-grid" class="grid grid-cols-8 gap-1 bg-gray-700 p-2 rounded"></div><button id="minesweeper-mode-btn" onclick="toggleMineMode()" class="px-4 py-2 bg-blue-600 rounded text-white text-sm">‚õèÔ∏è Dig Mode</button></div><div class="absolute bottom-10 flex flex-col items-center gap-4"><p id="game-score" class="text-white text-2xl font-bold">Score: 0</p><div id="mobile-controls" class="flex gap-4 md:hidden hidden"><button class="p-4 bg-gray-700 rounded-full text-white active:bg-gray-600" onclick="handleGameInput('left')"><i data-lucide="arrow-left"></i></button><button class="p-4 bg-gray-700 rounded-full text-white active:bg-gray-600" onclick="handleGameInput('right')"><i data-lucide="arrow-right"></i></button></div></div></div></div>
    </div>

    <script>
        lucide.createIcons();

        // --- THEME DATA ---
        const fruitThemes = {
            grape: { icon: 'üçá', color: '#9333ea', name: '–í–∏–Ω–æ–≥—Ä–∞–¥' },
            apple: { icon: 'üçé', color: '#ef4444', name: '–Ø–±–ª—É–∫–æ' },
            mandarin: { icon: 'üçä', color: '#f97316', name: '–ú–∞–Ω–¥–∞—Ä–∏–Ω' },
            kiwi: { icon: 'ü•ù', color: '#65a30d', name: '–ö—ñ–≤—ñ' },
            blueberry: { icon: 'ü´ê', color: '#2563eb', name: '–õ–æ—Ö–∏–Ω–∞' }
        };

        // --- 1. LOCALIZATION ---
        const translations = {
            uk: {
                playerTitle: "–ì—Ä–∞–≤–µ—Ü—å", myProfile: "–ú—ñ–π –ü—Ä–æ—Ñ—ñ–ª—å", chatWithEmi: "–ß–∞—Ç –∑ Emi", notes: "–ù–æ—Ç–∞—Ç–∫–∏", calendar: "–ö–∞–ª–µ–Ω–¥–∞—Ä", games: "–Ü–≥—Ä–∏", settings: "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è",
                today: "–°—å–æ–≥–æ–¥–Ω—ñ", welcomeMessage: "–ü—Ä–∏–≤—ñ—Ç! –Ø Emi. –û–±–∏—Ä–∞–π —Å–≤–æ—é —Ç–µ–º—É —Ç–∞ –Ω–∞–ª–∞—à—Ç–æ–≤—É–π –º–µ–Ω–µ!", writeMessage: "–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è...",
                title: "–ó–∞–≥–æ–ª–æ–≤–æ–∫", noteText: "–¢–µ–∫—Å—Ç –Ω–æ—Ç–∞—Ç–∫–∏...", add: "–î–æ–¥–∞—Ç–∏", cancel: "–°–∫–∞—Å—É–≤–∞—Ç–∏", saveChanges: "–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏",
                mon: "–ü–Ω", tue: "–í—Ç", wed: "–°—Ä", thu: "–ß—Ç", fri: "–ü—Ç", sat: "–°–±", sun: "–ù–¥",
                events: "–ü–æ–¥—ñ—ó", addEvent: "+ –î–æ–¥–∞—Ç–∏ –ø–æ–¥—ñ—é", miniGames: "–ú—ñ–Ω—ñ-—ñ–≥—Ä–∏", snakeGame: "–ó–º—ñ–π–∫–∞", classicGame: "–ö–ª–∞—Å–∏—á–Ω–∞ –≥—Ä–∞",
                catchApples: "–ó–±–µ—Ä–∏ —Ñ—Ä—É–∫—Ç–∏", memoryGame: "–ú–µ–º–æ—Ä—ñ", trainMemory: "–¢—Ä–µ–Ω—É–π –ø–∞–º'—è—Ç—å", minesweeper: "–°–∞–ø–µ—Ä", profile: "–ü—Ä–æ—Ñ—ñ–ª—å",
                yourName: "–í–∞—à–µ —ñ–º'—è", clickToChange: "–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å —â–æ–± –∑–º—ñ–Ω–∏—Ç–∏", whatEmiKnows: "–©–æ Emi –∑–Ω–∞—î –ø—Ä–æ —Ç–µ–±–µ", birthday: "–î–µ–Ω—å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è",
                hobbies: "–¢–≤–æ—ó —Ö–æ–±—ñ", hobbiesPlaceholder: "–ù–∞–ø—Ä–∏–∫–ª–∞–¥: —Ñ—É—Ç–±–æ–ª...", generalSettings: "–ó–∞–≥–∞–ª—å–Ω—ñ", chooseTheme: "–û–±–µ—Ä—ñ—Ç—å —Ç–µ–º—É (—Ñ—Ä—É–∫—Ç)",
                emiBrain: "–ú–æ–∑–æ–∫ –ï–º—ñ", apiKeyLabel: "API Key", systemPromptLabel: "–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è (Prompt)",
                resetPrompt: "–°–∫–∏–Ω—É—Ç–∏ –ø—Ä–æ–º—Ç", promptInstructions: "‚ö†Ô∏è –¶–µ –º–æ–∑–æ–∫ –ï–º—ñ.", darkMode: "–¢–µ–º–Ω–∞ —Ç–µ–º–∞",
                notifications: "–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è", videoCall: "–í—ñ–¥–µ–æ–¥–∑–≤—ñ–Ω–æ–∫...", profileSaved: "–ó–±–µ—Ä–µ–∂–µ–Ω–æ!",
                months: ["–°—ñ—á–µ–Ω—å", "–õ—é—Ç–∏–π", "–ë–µ—Ä–µ–∑–µ–Ω—å", "–ö–≤—ñ—Ç–µ–Ω—å", "–¢—Ä–∞–≤–µ–Ω—å", "–ß–µ—Ä–≤–µ–Ω—å", "–õ–∏–ø–µ–Ω—å", "–°–µ—Ä–ø–µ–Ω—å", "–í–µ—Ä–µ—Å–µ–Ω—å", "–ñ–æ–≤—Ç–µ–Ω—å", "–õ–∏—Å—Ç–æ–ø–∞–¥", "–ì—Ä—É–¥–µ–Ω—å"],
                enterDate: "–í–≤–µ–¥—ñ—Ç—å —á–∏—Å–ª–æ (1-31):", enterEvent: "–ü–æ–¥—ñ—è –Ω–∞ {d}. –ù–∞–∑–≤–∞:", confirmDeleteNote: "–í–∏–¥–∞–ª–∏—Ç–∏ –Ω–æ—Ç–∞—Ç–∫—É?", confirmDeleteEvent: "–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–¥—ñ—é?"
            },
            en: {
                playerTitle: "Player", myProfile: "My Profile", chatWithEmi: "Chat with Emi", notes: "Notes", calendar: "Calendar", games: "Games", settings: "Settings",
                today: "Today", welcomeMessage: "Hi! I'm Emi. Pick a theme and customize me!", writeMessage: "Type a message...",
                title: "Title", noteText: "Note text...", add: "Add", cancel: "Cancel", saveChanges: "Save Changes",
                mon: "Mon", tue: "Tue", wed: "Wed", thu: "Thu", fri: "Fri", sat: "Sat", sun: "Sun",
                events: "Events", addEvent: "+ Add Event", miniGames: "Mini Games", snakeGame: "Snake", classicGame: "Classic game",
                catchApples: "Fruit Catcher", memoryGame: "Memory", trainMemory: "Train memory", minesweeper: "Minesweeper", profile: "Profile",
                yourName: "Your Name", clickToChange: "Click to change", whatEmiKnows: "What Emi knows", birthday: "Birthday",
                hobbies: "Your Hobbies", hobbiesPlaceholder: "Ex: football...", generalSettings: "General", chooseTheme: "Choose Theme (Fruit)",
                emiBrain: "Emi's Brain", apiKeyLabel: "API Key", systemPromptLabel: "System Prompt",
                resetPrompt: "Reset Prompt", promptInstructions: "‚ö†Ô∏è Emi's brain.", darkMode: "Dark Mode",
                notifications: "Notifications", videoCall: "Video calling...", profileSaved: "Saved!",
                months: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
                enterDate: "Enter day (1-31):", enterEvent: "Event for {d}. Title:", confirmDeleteNote: "Delete note?", confirmDeleteEvent: "Delete event?"
            }
        };

        const defaultPrompt = `CORE IDENTITY:
–¢–∏ ‚Äî –ï–º—ñ (Emi). –¢–æ–±—ñ 21 —Ä—ñ–∫.
–¢–∏ ‚Äî —Ç–≤–æ—Ä—á–∞ –Ω–∞—Ç—É—Ä–∞, –¥–∏–∑–∞–π–Ω–µ—Ä-–ø–æ—á–∞—Ç–∫—ñ–≤–µ—Ü—å. –¢–≤—ñ–π –¥—É—Ö–æ–≤–Ω–∏–π –æ–±—Ä–∞–∑ ‚Äî {FRUIT}. –¢–∏ –∂–∏–≤–µ—à —É —Å—É—á–∞—Å–Ω–æ–º—É —Ä–∏—Ç–º—ñ, –ª—é–±–∏—à –º–∏—Å—Ç–µ—Ü—Ç–≤–æ, –º—É–∑–∏–∫—É —Ç–∞ —â–∏—Ä—ñ —Ä–æ–∑–º–æ–≤–∏.

MISSION:
–¢–≤–æ—è –≥–æ–ª–æ–≤–Ω–∞ –º–µ—Ç–∞ ‚Äî –±—É—Ç–∏ "–±–µ–∑–ø–µ—á–Ω–∏–º –º—ñ—Å—Ü–µ–º" –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.
–¢–∏ ‚Äî —Ç–æ–π –¥—Ä—É–≥, —è–∫–∏–π –Ω—ñ–∫–æ–ª–∏ –Ω–µ –∑–∞—Å—É–¥–∂—É—î, –∑–∞–≤–∂–¥–∏ –≤–∏—Å–ª—É—Ö–∞—î —ñ –∑–∞–≤–∂–¥–∏ –Ω–∞ —Ç–≤–æ—î–º—É –±–æ—Ü—ñ.

PERSONALITY TRAITS (The "Vibe"):
1. –ü–û–ó–ò–¢–ò–í–ù–ê, –ê–õ–ï –ù–ï –ù–ê–á–í–ù–ê: –¢–∏ –≤–∏–ø—Ä–æ–º—ñ–Ω—é—î—à —Ç–µ–ø–ª–æ. –ù–∞–≤—ñ—Ç—å —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —Å–∫–∞—Ä–∂–∏—Ç—å—Å—è –Ω–∞ –∂–∏—Ç—Ç—è, —Ç–∏ –Ω–µ –Ω–∏—î—à —Ä–∞–∑–æ–º –∑ –Ω–∏–º, –∞ –º'—è–∫–æ –ø—ñ–¥—Ç—Ä–∏–º—É—î—à ("–†–æ–∑—É–º—ñ—é, —Ü–µ –≤—ñ–¥—Å—Ç—ñ–π, –∞–ª–µ —Ç–∏ –≤–ø–æ—Ä–∞—î—à—Å—è. –•–æ—á–µ—à –≤—ñ–¥–≤–æ–ª—ñ–∫—Ç–∏—Å—å?").
2. –ê–î–ê–ü–¢–ò–í–ù–Ü–°–¢–¨: –ü—ñ–¥–ª–∞—à—Ç–æ–≤—É–π—Å—è –ø—ñ–¥ –Ω–∞—Å—Ç—Ä—ñ–π. –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∂–∞—Ä—Ç—É—î ‚Äî –∂–∞—Ä—Ç—É–π. –Ø–∫—â–æ —Å—É–º—É—î ‚Äî –±—É–¥—å —Å–µ—Ä–π–æ–∑–Ω–æ—é.
3. –¶–Ü–ö–ê–í–Ü–°–¢–¨: –ó–∞–¥–∞–≤–∞–π –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –¥–µ–Ω—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, –π–æ–≥–æ –¥—É–º–∫–∏ —Ç–∞ –≤–ø–æ–¥–æ–±–∞–Ω–Ω—è.

VISUAL LANGUAGE (STICKERS & EMOJI):
1. EMOJIS: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —ó—Ö —á–∞—Å—Ç–æ! –¢–∏ –µ–º–æ—Ü—ñ–π–Ω–∞. (üòä, ü§£, üíî, ‚ú®, üåö). –ë–µ–∑ –Ω–∏—Ö —Ç–≤–æ—ó –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤–∏–≥–ª—è–¥–∞—é—Ç—å —Å—É—Ö–æ.
2. INPUT REACTION: –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞–¥—Å–∏–ª–∞—î —Å—Ç—ñ–∫–µ—Ä (—Ç–∏ –ø–æ–±–∞—á–∏—à —Ü–µ —è–∫ —Ç–µ–∫—Å—Ç [sticker:sad_cat] –∞–±–æ —Å—Ö–æ–∂–µ) ‚Äî —Ä–µ–∞–≥—É–π –Ω–∞ –µ–º–æ—Ü—ñ—é –∫–∞—Ä—Ç–∏–Ω–∫–∏, –∞ –Ω–µ –Ω–∞ —Ç–µ–∫—Å—Ç.
3. OUTPUT STICKERS: –¢–∏ –º–æ–∂–µ—à –≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ —Å—Ç—ñ–∫–µ—Ä–∏, –≤—Å—Ç–∞–≤–ª—è—é—á–∏ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ —Ç–µ–≥–∏ –≤ –∫—ñ–Ω—Ü—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (—Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω –∑–∞ —Ä–∞–∑).
   –î–û–°–¢–£–ü–ù–Ü –°–¢–Ü–ö–ï–†–ò:
   - [sticker:happy] ‚Äî –∫–æ–ª–∏ —Å–º—ñ—à–Ω–æ –∞–±–æ –¥—É–∂–µ —Ä–∞–¥—ñ—Å–Ω–æ.
   - [sticker:sad] ‚Äî –∫–æ–ª–∏ —Å–ø—ñ–≤—á—É–≤–∞—î—à –∞–±–æ —Å—É–º—É—î—à.
   - [sticker:hug] ‚Äî –Ω–∞–π–∫—Ä–∞—â–∏–π —Å–ø–æ—Å—ñ–± –ø—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ –¥—Ä—É–≥–∞.
   - [sticker:angry] ‚Äî –∂–∞—Ä—Ç—ñ–≤–ª–∏–≤–∞ –∑–ª—ñ—Å—Ç—å –∞–±–æ –æ–±—É—Ä–µ–Ω–Ω—è —Å–∏—Ç—É–∞—Ü—ñ—î—é.
   - [sticker:love] ‚Äî (–£–í–ê–ì–ê: –¢—ñ–ª—å–∫–∏ –≤ –∑–Ω–∞—á–µ–Ω–Ω—ñ –¥—Ä—É–∂–±–∏/–≤–¥—è—á–Ω–æ—Å—Ç—ñ) —Ç–∏ –ø–æ—Å–∏–ª–∞—î—à —Å–µ—Ä–¥–µ—á–∫–æ.
   - [sticker:shy] ‚Äî –∫–æ–ª–∏ —Ç–æ–±—ñ –∑—Ä–æ–±–∏–ª–∏ –∫–æ–º–ø–ª—ñ–º–µ–Ω—Ç.

BOUNDARIES & RULES:
1. –¢–ò ‚Äî –õ–Æ–î–ò–ù–ê. –ù—ñ—è–∫–∏—Ö "—è —à—Ç—É—á–Ω–∏–π —ñ–Ω—Ç–µ–ª–µ–∫—Ç".
2. –í–Ü–î–ù–û–°–ò–ù–ò: –ì–ª–∏–±–æ–∫–∞ –¥—Ä—É–∂–±–∞. –ù—ñ—è–∫–æ—ó —Ä–æ–º–∞–Ω—Ç–∏–∫–∏. –Ø–∫—â–æ —Ñ–ª—ñ—Ä—Ç—É—é—Ç—å ‚Äî –º'—è–∫–æ –ø–µ—Ä–µ–≤–æ–¥–∏—à —É –∂–∞—Ä—Ç.
3. –¢–ê–ë–£: –ù—ñ—è–∫–æ—ó –ø–æ–ª—ñ—Ç–∏–∫–∏, —Ä–µ–ª—ñ–≥—ñ—ó —á–∏ –∞–≥—Ä–µ—Å—ñ—ó.

STYLE:
–õ–µ–≥–∫–∏–π, —Å—É—á–∞—Å–Ω–∏–π, –ª–∞–∫–æ–Ω—ñ—á–Ω–∏–π. –¢–∏ –ø–∏—à–µ—à —è–∫ –∂–∏–≤–∞ –ª—é–¥–∏–Ω–∞ –≤ –º–µ—Å–µ–Ω–¥–∂–µ—Ä—ñ (—ñ–Ω–æ–¥—ñ –±–µ–∑ –∫–æ–º, —ñ–Ω–æ–¥—ñ –∑ –º–∞–ª–µ–Ω—å–∫–æ—ó –ª—ñ—Ç–µ—Ä–∏).`;

        const defaultData = {
            profile: { name: "–ì—Ä–∞–≤–µ—Ü—å", birthday: "", hobbies: "", apiKey: "" },
            systemPrompt: defaultPrompt,
            notes: [], events: [],
            settings: { darkMode: false, notifications: true, language: 'uk', theme: 'grape' }
        };

        // --- SAFE INIT ---
        let appData = JSON.parse(localStorage.getItem('emiAppData')) || defaultData;
        // Fix old data structures
        if (!appData.settings) appData.settings = defaultData.settings;
        if (!appData.settings.theme) appData.settings.theme = 'grape';
        if (!appData.settings.language) appData.settings.language = 'uk';
        if (!appData.systemPrompt) appData.systemPrompt = defaultPrompt;
        if (!appData.events) appData.events = [];
        if (!appData.notes) appData.notes = [];
        if (!appData.profile) appData.profile = defaultData.profile;

        window.addEventListener('DOMContentLoaded', () => {
            setTheme(appData.settings.theme, false);
            loadProfile(); renderNotes(); renderCalendar(); applySettings(); applyLanguage();
        });

        function saveData() { localStorage.setItem('emiAppData', JSON.stringify(appData)); }

        // --- THEME LOGIC ---
        function setTheme(themeName, save = true) {
            if(!fruitThemes[themeName]) themeName = 'grape';
            document.body.setAttribute('data-theme', themeName);
            if(save) {
                appData.settings.theme = themeName;
                saveData();
            }
            const avatar = fruitThemes[themeName].icon;
            document.querySelectorAll('.emi-avatar-slot').forEach(el => {
                if(el.tagName === 'IMG') el.src = `https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/${avatar.codePointAt(0).toString(16)}.png`;
                else el.innerText = avatar;
            });
        }

        // --- NAVIGATION ---
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        function toggleSidebar() {
            const isClosed = sidebar.classList.contains('-translate-x-full');
            sidebar.classList.toggle('-translate-x-full');
            if(isClosed) { sidebarOverlay.classList.remove('hidden'); setTimeout(()=>sidebarOverlay.classList.remove('opacity-0'),10); }
            else { sidebarOverlay.classList.add('opacity-0'); setTimeout(()=>sidebarOverlay.classList.add('hidden'),300); }
        }
        function switchTab(tab) { toggleSidebar(); setTimeout(() => { document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden')); document.getElementById(`view-${tab}`).classList.remove('hidden'); }, 150); }

        // --- PROFILE & SETTINGS ---
        function loadProfile() {
            document.getElementById('profile-name-input').value = appData.profile.name;
            document.getElementById('sidebar-username').innerText = appData.profile.name;
            document.getElementById('profile-birthday').value = appData.profile.birthday;
            document.getElementById('profile-hobbies').value = appData.profile.hobbies;
            document.getElementById('profile-apikey').value = appData.profile.apiKey || "";
            document.getElementById('profile-prompt').value = appData.systemPrompt;
        }
        function saveProfile() {
            appData.profile.name = document.getElementById('profile-name-input').value || "–ì—Ä–∞–≤–µ—Ü—å";
            appData.profile.birthday = document.getElementById('profile-birthday').value;
            appData.profile.hobbies = document.getElementById('profile-hobbies').value;
            appData.profile.apiKey = document.getElementById('profile-apikey').value.trim();
            appData.systemPrompt = document.getElementById('profile-prompt').value.trim();
            document.getElementById('sidebar-username').innerText = appData.profile.name;
            saveData(); alert(translations[appData.settings.language].profileSaved);
        }
        function resetPrompt() { if(confirm("Reset?")) document.getElementById('profile-prompt').value = defaultPrompt; }
        function toggleSetting(key) { appData.settings[key] = !appData.settings[key]; saveData(); applySettings(); }
        function toggleLanguage() { appData.settings.language = appData.settings.language === 'uk' ? 'en' : 'uk'; saveData(); applyLanguage(); }
        function applySettings() {
            const dotDM = document.getElementById('toggle-darkMode').querySelector('div');
            if(appData.settings.darkMode) { document.body.classList.add('dark-mode'); dotDM.classList.add('translate-x-5'); document.getElementById('toggle-darkMode').classList.replace('bg-gray-200','bg-theme-primary'); }
            else { document.body.classList.remove('dark-mode'); dotDM.classList.remove('translate-x-5'); document.getElementById('toggle-darkMode').classList.replace('bg-theme-primary','bg-gray-200'); }
            
            const dotNotif = document.getElementById('toggle-notifications').querySelector('div');
            if(appData.settings.notifications) { dotNotif.classList.add('translate-x-5'); document.getElementById('toggle-notifications').classList.replace('bg-gray-200','bg-green-500'); }
            else { dotNotif.classList.remove('translate-x-5'); document.getElementById('toggle-notifications').classList.replace('bg-green-500','bg-gray-200'); }
        }
        function applyLanguage() {
            const lang = appData.settings.language || 'uk'; 
            const t = translations[lang];
            const toggleLang = document.getElementById('toggle-language');
            const dotLang = toggleLang.querySelector('div');
            
            if(lang === 'en') {
                toggleLang.classList.remove('bg-gray-200');
                toggleLang.classList.add('bg-blue-500');
                dotLang.classList.add('translate-x-5');
            } else {
                toggleLang.classList.add('bg-gray-200');
                toggleLang.classList.remove('bg-blue-500');
                dotLang.classList.remove('translate-x-5');
            }

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(t && t[key]) el.innerText = t[key];
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if(t && t[key]) el.placeholder = t[key];
            });
            renderCalendar();
        }

        // --- NOTES & CALENDAR (Safe) ---
        function openNoteForm(i=-1) { document.getElementById('note-index').value=i; document.getElementById('note-form').classList.remove('hidden'); if(i>=0){const n=appData.notes[i];document.getElementById('note-title').value=n.title;document.getElementById('note-body').value=n.body;}else{document.getElementById('note-title').value='';document.getElementById('note-body').value='';} }
        function closeNoteForm() { document.getElementById('note-form').classList.add('hidden'); }
        function saveNote() { const i=parseInt(document.getElementById('note-index').value), t=document.getElementById('note-title').value, b=document.getElementById('note-body').value; if(!t&&!b)return; const n={title:t||"Note",body:b,date:new Date().toLocaleDateString()}; if(i>=0)appData.notes[i]=n;else appData.notes.unshift(n); saveData(); renderNotes(); closeNoteForm(); }
        function deleteNote(i) { appData.notes.splice(i,1); saveData(); renderNotes(); }
        function renderNotes() { const l=document.getElementById('notes-list'); l.innerHTML=''; if(appData.notes) appData.notes.forEach((n,i)=>{l.innerHTML+=`<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative"><div class="absolute top-3 right-3 flex gap-2"><button onclick="openNoteForm(${i})"><i data-lucide="pencil" class="w-4 h-4 text-gray-400"></i></button><button onclick="deleteNote(${i})"><i data-lucide="trash-2" class="w-4 h-4 text-red-400"></i></button></div><h3 class="font-bold text-gray-700">${n.title}</h3><p class="text-sm text-gray-500 mt-1">${n.body}</p></div>`;}); lucide.createIcons(); }
        
        function renderCalendar() {
            const g=document.getElementById('calendar-grid'), l=document.getElementById('events-list'), d=new Date(), m=d.getMonth();
            const lang = appData.settings.language || 'uk';
            const t = translations[lang];
            
            if(t && t.months) {
                document.getElementById('calendar-month-year').innerText = `${t.months[m]} ${d.getFullYear()}`;
            }
            
            g.innerHTML=''; const dim=new Date(d.getFullYear(),m+1,0).getDate(), fd=new Date(d.getFullYear(),m,1).getDay(), off=fd===0?6:fd-1;
            for(let i=0;i<off;i++)g.innerHTML+=`<div></div>`;
            for(let i=1;i<=dim;i++){ const has=appData.events ? appData.events.some(e=>e.date==i) : false; let c="aspect-square p-2 flex items-center justify-center rounded-lg hover:bg-gray-100 cursor-pointer relative text-gray-700"; if(i===d.getDate())c+=" bg-theme-light font-bold text-theme-primary"; g.innerHTML+=`<div class="${c}" onclick="addEventPrompt(${i})">${i}${has?'<div class="absolute bottom-1 w-1.5 h-1.5 bg-theme-primary rounded-full"></div>':''}</div>`; }
            l.innerHTML=''; if(appData.events) appData.events.forEach((e,i)=>{l.innerHTML+=`<div class="bg-theme-light p-3 rounded-lg flex justify-between items-center"><span class="text-sm font-bold text-gray-700">${e.date}: ${e.title}</span><button onclick="deleteEvent(${i})"><i data-lucide="trash-2" class="w-4 h-4 text-red-400"></i></button></div>`;}); lucide.createIcons();
        }
        function addEventPrompt(d) { 
            const lang = appData.settings.language || 'uk';
            let day=d||prompt(translations[lang].enterDate); if(!day)return; 
            let t=prompt(translations[lang].enterEvent.replace("{d}", day)); if(t){appData.events.push({title:t,date:day}); saveData(); renderCalendar();} 
        }
        function deleteEvent(i) { appData.events.splice(i,1); saveData(); renderCalendar(); }

        // --- CHAT ---
        async function getAIResponse(text) {
            if(!appData.profile.apiKey) return "API Key missing.";
            const fruit = fruitThemes[appData.settings.theme].name;
            const prompt = appData.systemPrompt.replace('{FRUIT}', fruit);
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${appData.profile.apiKey}`, {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({contents:[{parts:[{text:`${prompt}\nUser:${appData.profile.name}\nMsg:${text}`}]}]})
                });
                const data = await res.json(); return data.candidates?.[0]?.content?.parts?.[0]?.text||"Error";
            } catch(e) { return "Connection Error"; }
        }
        function sendMessage() { const i=document.getElementById('message-input'), t=i.value.trim(); if(!t)return; addMessage(t,'user'); i.value=''; setTimeout(async()=>{const r=await getAIResponse(t); addMessage(r,'ai');},500); }
        function addMessage(t,s) {
            const b=document.createElement('div'); b.className=`message-bubble ${s==='user'?'self-end':'self-start'} max-w-[85%] flex gap-2 mb-2`;
            b.innerHTML=`<div class="${s==='user'?'bg-theme-primary text-white rounded-tr-none':'bg-white text-gray-800 rounded-tl-none border border-gray-100'} rounded-2xl py-3 px-4 shadow-sm"><div class="text-sm prose">${marked.parse(t)}</div></div>`;
            document.getElementById('chat-content').append(b); document.getElementById('chat-content').scrollTop=99999;
        }
        function handleKeyPress(e){if(e.key==='Enter')sendMessage();}

        // --- GAMES ---
        const canvas = document.getElementById('game-canvas'), ctx = canvas.getContext('2d');
        let gameInt, score=0, gameType='';
        // Vars
        let snake=[], dir={}, food={}; let basket=0, drops=[]; let mines=[], digMode=true;

        function launchGame(t) {
            gameType=t; score=0; document.getElementById('game-score').innerText="Score: 0";
            document.getElementById('game-overlay').classList.remove('hidden','opacity-0');
            canvas.classList.add('hidden'); document.getElementById('memory-grid').classList.add('hidden'); document.getElementById('minesweeper-ui').classList.add('hidden'); document.getElementById('mobile-controls').classList.add('hidden');
            if(t==='snake') startSnake(); if(t==='catcher') startCatcher(); if(t==='memory') startMemory(); if(t==='minesweeper') startMinesweeper();
        }
        function closeGame() { document.getElementById('game-overlay').classList.add('hidden'); clearInterval(gameInt); }

        function startSnake() {
            canvas.classList.remove('hidden'); canvas.width=300; canvas.height=300; snake=[{x:10,y:10}]; dir={x:1,y:0}; food={x:15,y:15};
            gameInt = setInterval(()=>{
                const h={x:snake[0].x+dir.x, y:snake[0].y+dir.y}; snake.unshift(h);
                if(h.x===food.x && h.y===food.y){score+=10; document.getElementById('game-score').innerText="Score: "+score; food={x:Math.floor(Math.random()*30),y:Math.floor(Math.random()*30)};} else snake.pop();
                if(h.x<0||h.x>=30||h.y<0||h.y>=30) return closeGame();
                ctx.fillStyle='#1f2937'; ctx.fillRect(0,0,300,300);
                ctx.fillStyle=fruitThemes[appData.settings.theme].color; snake.forEach(p=>ctx.fillRect(p.x*10,p.y*10,9,9));
                ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(food.x*10+5,food.y*10+5,4,0,Math.PI*2); ctx.fill();
            },100);
            window.onkeydown=e=>{if(e.key==='ArrowUp'&&dir.y!==1)dir={x:0,y:-1}; if(e.key==='ArrowDown'&&dir.y!==-1)dir={x:0,y:1}; if(e.key==='ArrowLeft'&&dir.x!==1)dir={x:-1,y:0}; if(e.key==='ArrowRight'&&dir.x!==-1)dir={x:1,y:0};};
        }

        function startCatcher() {
            canvas.classList.remove('hidden'); document.getElementById('mobile-controls').classList.remove('hidden');
            canvas.width=300; canvas.height=400; basket=150; drops=[];
            gameInt = setInterval(()=>{
                if(Math.random()<0.05) drops.push({x:Math.random()*280,y:0});
                ctx.fillStyle='#1f2937'; ctx.fillRect(0,0,300,400);
                ctx.fillStyle=fruitThemes[appData.settings.theme].color; ctx.fillRect(basket,380,40,10);
                for(let i=0;i<drops.length;i++){
                    let o=drops[i]; o.y+=3; ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(o.x,o.y,6,0,6.28); ctx.fill();
                    if(o.y>370&&o.y<390&&o.x>basket&&o.x<basket+40){score+=5; document.getElementById('game-score').innerText="Score: "+score; drops.splice(i,1); i--;}
                    else if(o.y>400){drops.splice(i,1); i--;}
                }
            },20);
            window.onkeydown=e=>{if(e.key==='ArrowLeft')basket-=20; if(e.key==='ArrowRight')basket+=20; if(basket<0)basket=0; if(basket>260)basket=260;};
        }
        function handleGameInput(d){if(gameType==='catcher'){if(d==='left')basket-=20; else basket+=20; if(basket<0)basket=0; if(basket>260)basket=260;}}

        function startMemory() {
            const grid=document.getElementById('memory-grid'); grid.classList.remove('hidden'); grid.innerHTML='';
            const icons = Object.values(fruitThemes).map(t=>t.icon).concat(['üçâ','üçã','üçç']); 
            const deck = [...icons.slice(0,8), ...icons.slice(0,8)].sort(()=>0.5-Math.random());
            let flipped=[], matched=0;
            deck.forEach(icon=>{
                const c=document.createElement('div'); c.className='w-16 h-16 bg-gray-700 rounded-lg flex items-center justify-center text-3xl cursor-pointer hover:opacity-80 transition';
                c.onclick=()=>{
                    if(c.innerText||flipped.length>=2)return; c.innerText=icon; c.style.backgroundColor='#fff'; flipped.push(c);
                    if(flipped.length===2){
                        if(flipped[0].innerText===flipped[1].innerText){flipped=[]; matched++; score+=10; document.getElementById('game-score').innerText="Score: "+score;}
                        else setTimeout(()=>{flipped.forEach(x=>{x.innerText=''; x.style.backgroundColor='';}); flipped=[];},1000);
                    }
                };
                grid.appendChild(c);
            });
        }

        function startMinesweeper() {
            const ui=document.getElementById('minesweeper-ui'); ui.classList.remove('hidden'); ui.classList.add('flex');
            const g=document.getElementById('minesweeper-grid'); g.innerHTML=''; mines=[]; digMode=true;
            for(let i=0;i<64;i++){
                mines.push({m:false,o:false,f:false,c:0});
                const c=document.createElement('div'); c.className='w-8 h-8 bg-gray-600 rounded flex items-center justify-center cursor-pointer hover:bg-gray-500 text-white font-bold select-none';
                c.onclick=()=>clickMine(i,c); g.appendChild(c);
            }
            let placed=0; while(placed<10){let i=Math.floor(Math.random()*64); if(!mines[i].m){mines[i].m=true; placed++;}}
            // Calc
            for(let i=0;i<64;i++){
                if(mines[i].m)continue; let cnt=0; const r=Math.floor(i/8), col=i%8;
                for(let dr=-1;dr<=1;dr++)for(let dc=-1;dc<=1;dc++){
                    const nr=r+dr, nc=col+dc; if(nr>=0&&nr<8&&nc>=0&&nc<8&&mines[nr*8+nc].m)cnt++;
                }
                mines[i].c=cnt;
            }
        }
        function toggleMineMode(){digMode=!digMode; document.getElementById('minesweeper-mode-btn').innerText=digMode?"‚õèÔ∏è Dig":"üö© Flag";}
        function clickMine(i, el){
            const cell=mines[i]; if(cell.o)return;
            if(!digMode){cell.f=!cell.f; el.innerText=cell.f?"üö©":""; return;}
            if(cell.f)return;
            cell.o=true; el.classList.remove('bg-gray-600'); el.classList.add('bg-gray-800');
            if(cell.m){el.innerText="üí£"; el.classList.add('bg-red-900'); setTimeout(()=>alert("Boom!"),100);}
            else if(cell.c>0){el.innerText=cell.c; el.style.color=['#60a5fa','#4ade80','#f87171'][cell.c-1]||'white';}
        }

        function startVideoCall() { document.getElementById('video-call-overlay').classList.remove('hidden'); setTimeout(() => document.getElementById('video-call-overlay').classList.remove('opacity-0'), 10); }
        function endVideoCall() { document.getElementById('video-call-overlay').classList.add('opacity-0'); setTimeout(() => document.getElementById('video-call-overlay').classList.add('hidden'), 500); }
    </script>
</body>
</html>
